This file is a merged representation of the entire codebase, combined into a single document by Repomix.

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)


================================================================
Directory Structure
================================================================
app/
  actions/
    dictionary.ts
    playground.ts
    settings.ts
    sources.ts
    system.ts
  analytics/
    page.tsx
  data-quality/
    page.tsx
  dictionary/
    page.tsx
  logs/
    page.tsx
  playground/
    page.tsx
  products/
    [id]/
      page.tsx
    page.tsx
  raw-data/
    page.tsx
  reviews/
    page.tsx
  settings/
    page.tsx
  shops/
    page.tsx
  sources/
    page.tsx
  system-health/
    page.tsx
  error.tsx
  layout.tsx
  loading.tsx
  page.tsx
  providers.tsx
components/
  analytics-tables.tsx
  base-products-table.tsx
  breadcrumbs.tsx
  command-palette.tsx
  counter.tsx
  create-source-modal.tsx
  dashboard-chart.tsx
  data-quality-table.tsx
  date-range-filter.tsx
  dictionary-editor.tsx
  download-btn.tsx
  edit-source-modal.tsx
  icons.tsx
  logs-table.tsx
  main-layout.tsx
  maintenance-panel.tsx
  negative-reviews-table.tsx
  primitives.ts
  product-history-chart.tsx
  product-version-history-table.tsx
  rating-pie-chart.tsx
  raw-data-table.tsx
  recent-logs-table.tsx
  search-input.tsx
  settings-editor.tsx
  shops-table.tsx
  sidebar-context.tsx
  sidebar.tsx
  slow-queries-table.tsx
  sources-table.tsx
  text-diff-viewer.tsx
  theme-switch.tsx
  version-diff-modal.tsx
config/
  fonts.ts
  site.ts
lib/
  prisma.ts
  utils.ts
prisma/
  schema.prisma
public/
  favicon.ico
  next.svg
  vercel.svg
styles/
  globals.css
types/
  index.ts
  schema.ts
.gitignore
.npmrc
eslint.config.mjs
LICENSE
next.config.js
package.json
postcss.config.js
prisma.config.ts
README.md
tailwind.config.js
tsconfig.json

================================================================
Files
================================================================

================
File: app/actions/dictionary.ts
================
"use server";

import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";

// 1. Lấy dữ liệu từ điển (Merge giữa Schema thực tế và Note đã lưu)
export async function getDictionaryData() {
  try {
    // A. Lấy Metadata kỹ thuật (Cột, Kiểu dữ liệu)
    const rawColumns: any[] = await prisma.$queryRaw`
      SELECT 
        table_schema, 
        table_name, 
        column_name, 
        data_type,
        ordinal_position
      FROM information_schema.columns 
      WHERE table_schema IN ('staging', 'warehouse')
      ORDER BY table_schema, table_name, ordinal_position;
    `;

    // B. Lấy Metadata nghiệp vụ (Ghi chú đã lưu)
    const savedNotes = await prisma.data_dictionary_notes.findMany();

    // C. Map ghi chú vào cột
    // Tạo Map để tra cứu cho nhanh: "schema.table.col" -> description
    const noteMap = new Map();
    savedNotes.forEach(note => {
      noteMap.set(`${note.schema_name}.${note.table_name}.${note.column_name}`, note.description);
    });

    const dictionaryTree: any = {};

    rawColumns.forEach((row) => {
      const { table_schema, table_name, column_name, data_type } = row;
      const key = `${table_schema}.${table_name}.${column_name}`;
      
      if (!dictionaryTree[table_schema]) dictionaryTree[table_schema] = {};
      if (!dictionaryTree[table_schema][table_name]) dictionaryTree[table_schema][table_name] = [];

      dictionaryTree[table_schema][table_name].push({
        name: column_name,
        type: data_type,
        description: noteMap.get(key) || ""
      });
    });

    return { success: true, data: dictionaryTree };

  } catch (error) {
    console.error("Dictionary fetch error:", error);
    return { error: "Failed to load dictionary" };
  }
}

export async function saveColumnNote(schema: string, table: string, col: string, desc: string) {
  try {
    await prisma.data_dictionary_notes.upsert({
      where: {
        schema_name_table_name_column_name: {
          schema_name: schema,
          table_name: table,
          column_name: col
        }
      },
      update: {
        description: desc,
        updated_at: new Date()
      },
      create: {
        schema_name: schema,
        table_name: table,
        column_name: col,
        description: desc
      }
    });
    
    revalidatePath("/dictionary");
    return { success: true };
  } catch (error) {
    console.error("Save note error:", error);
    return { error: "Failed to save note" };
  }
}

================
File: app/actions/playground.ts
================
"use server";

import { prisma } from "@/lib/prisma";
import { serializeData } from "@/lib/utils";

export async function executeRawQuery(query: string) {
    const forbiddenKeywords = ["INSERT", "UPDATE", "DELETE", "DROP", "ALTER", "TRUNCATE", "GRANT", "REVOKE"];
    const upperQuery = query.trim().toUpperCase();

    if (!upperQuery.startsWith("SELECT") && !upperQuery.startsWith("WITH")) {
        const hasForbidden = forbiddenKeywords.some(keyword => upperQuery.includes(keyword));
        if (hasForbidden) {
            return { error: "Security Alert: Only SELECT queries are allowed in Playground mode." };
        }
    }

    try {
        const result: any[] = await prisma.$queryRawUnsafe(query);

        return { success: true, data: serializeData(result) };
    } catch (error: any) {
        return { error: error.message || "Query execution failed" };
    }
}

export async function getDatabaseMetadata() {
  try {
    const rawData: any[] = await prisma.$queryRaw`
      SELECT 
        table_schema, 
        table_name, 
        column_name, 
        data_type 
      FROM information_schema.columns 
      WHERE table_schema IN ('staging', 'warehouse', 'controller')
      ORDER BY table_schema, table_name, ordinal_position;
    `;

    type ColumnInfo = { name: string; type: string };
    
    const schemaTree: Record<string, Record<string, ColumnInfo[]>> = {};

    rawData.forEach((row) => {
      const schema = row.table_schema;
      const table = row.table_name;
      
      if (!schemaTree[schema]) {
        schemaTree[schema] = {};
      }
      if (!schemaTree[schema][table]) {
        schemaTree[schema][table] = [];
      }
      
      schemaTree[schema][table].push({
        name: row.column_name,
        type: row.data_type
      });
    });

    return { success: true, data: schemaTree };
  } catch (error: any) {
    console.error("Metadata fetch error:", error);
    return { error: "Failed to fetch database metadata" };
  }
}

================
File: app/actions/system.ts
================
"use server";

import { prisma } from "@/lib/prisma";

export async function getDatabaseHealth() {
  try {
    // 1. Lấy size của từng bảng (Top 10 bảng nặng nhất)
    const tableStats: any[] = await prisma.$queryRaw`
      SELECT
        relname as table_name,
        n_live_tup as row_count,
        pg_size_pretty(pg_total_relation_size(relid)) as total_size,
        pg_total_relation_size(relid) as total_bytes
      FROM pg_stat_user_tables
      ORDER BY pg_total_relation_size(relid) DESC
      LIMIT 10;
    `;

    // 2. Lấy tổng size Database
    const dbSize: any[] = await prisma.$queryRaw`
      SELECT pg_size_pretty(pg_database_size(current_database())) as size;
    `;

    // 3. Lấy thông tin Cache Hit Ratio (Hiệu suất DB)
    // Nếu > 99% là tốt, thấp hơn nghĩa là thiếu RAM hoặc Index kém
    const cacheHit: any[] = await prisma.$queryRaw`
      SELECT 
        sum(heap_blks_hit) / (sum(heap_blks_hit) + sum(heap_blks_read)) * 100 as ratio
      FROM pg_statio_user_tables;
    `;

    // 4. Kiểm tra Index Usage (Bảng nào đang bị quét full table scan nhiều)
    const indexUsage: any[] = await prisma.$queryRaw`
      SELECT 
        relname as table_name,
        seq_scan as full_scans,
        idx_scan as index_scans
      FROM pg_stat_user_tables
      WHERE seq_scan > 1000
      ORDER BY seq_scan DESC
      LIMIT 5;
    `;

    return {
      tableStats: tableStats.map(t => ({...t, row_count: Number(t.row_count), total_bytes: Number(t.total_bytes)})),
      dbSize: dbSize[0]?.size || "Unknown",
      cacheHitRatio: Number(cacheHit[0]?.ratio || 0),
      indexUsage: indexUsage.map(t => ({...t, full_scans: Number(t.full_scans), index_scans: Number(t.index_scans)}))
    };
  } catch (error) {
    console.error("DB Health Check Error:", error);
    return null;
  }
}

================
File: app/loading.tsx
================
import { Spinner } from "@heroui/spinner";

export default function Loading() {
  return (
    <div className="flex h-[50vh] w-full items-center justify-center">
      <div className="flex flex-col items-center gap-4">
        <Spinner size="lg" color="primary" label="Loading data..." />
      </div>
    </div>
  );
}

================
File: app/providers.tsx
================
"use client";

import type { ThemeProviderProps } from "next-themes";

import * as React from "react";
import { HeroUIProvider } from "@heroui/system";
import { useRouter } from "next/navigation";
import { ThemeProvider as NextThemesProvider } from "next-themes";

export interface ProvidersProps {
  children: React.ReactNode;
  themeProps?: ThemeProviderProps;
}

declare module "@react-types/shared" {
  interface RouterConfig {
    routerOptions: NonNullable<
      Parameters<ReturnType<typeof useRouter>["push"]>[1]
    >;
  }
}

export function Providers({ children, themeProps }: ProvidersProps) {
  const router = useRouter();

  return (
    <HeroUIProvider navigate={router.push}>
      <NextThemesProvider {...themeProps}>{children}</NextThemesProvider>
    </HeroUIProvider>
  );
}

================
File: components/breadcrumbs.tsx
================
"use client";

import { usePathname } from "next/navigation";
import Link from "next/link";
import { ChevronRightIcon, HomeIcon } from "lucide-react";

export const Breadcrumbs = () => {
  const pathname = usePathname();
  
  // Bỏ qua nếu ở trang chủ
  if (pathname === "/") return null;

  const pathSegments = pathname.split("/").filter((segment) => segment !== "");

  return (
    <nav className="flex items-center text-sm text-default-500 mb-4">
      <Link href="/" className="hover:text-primary flex items-center gap-1">
        <HomeIcon size={14} />
      </Link>
      
      {pathSegments.map((segment, index) => {
        const href = `/${pathSegments.slice(0, index + 1).join("/")}`;
        const isLast = index === pathSegments.length - 1;
        
        // Format text: "raw-data" -> "Raw Data"
        const title = segment.replace(/-/g, " ").replace(/%20/g, " ");

        return (
          <div key={href} className="flex items-center">
            <ChevronRightIcon size={14} className="mx-1 text-default-300" />
            {isLast ? (
              <span className="font-semibold text-foreground capitalize">
                {decodeURIComponent(title)}
              </span>
            ) : (
              <Link href={href} className="hover:text-primary capitalize">
                {decodeURIComponent(title)}
              </Link>
            )}
          </div>
        );
      })}
    </nav>
  );
};

================
File: components/counter.tsx
================
"use client";

import { useState } from "react";
import { Button } from "@heroui/button";

export const Counter = () => {
  const [count, setCount] = useState(0);

  return (
    <Button radius="full" onPress={() => setCount(count + 1)}>
      Count is {count}
    </Button>
  );
};

================
File: components/date-range-filter.tsx
================
"use client";

import { DateRangePicker } from "@heroui/date-picker";
import { parseDate, getLocalTimeZone, today, DateValue } from "@internationalized/date";
import { useRouter, useSearchParams, usePathname } from "next/navigation";
import type { RangeValue } from "@react-types/shared";

export const DateRangeFilter = () => {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // 1. Lấy giá trị từ URL hoặc mặc định
  const fromParam = searchParams.get("from");
  const toParam = searchParams.get("to");

  // Helper để lấy ngày hôm nay
  const now = today(getLocalTimeZone());

  // Giá trị mặc định cho Picker
  const defaultValue = {
    start: fromParam ? parseDate(fromParam) : now.subtract({ days: 7 }),
    end: toParam ? parseDate(toParam) : now,
  };

  // 2. Xử lý khi chọn ngày
  // FIX: Thêm `| null` vào kiểu tham số để khớp với định nghĩa của HeroUI
  const handleDateChange = (range: RangeValue<DateValue> | null) => {
  const params = new URLSearchParams(searchParams);

  if (range) {
    // Trường hợp chọn ngày: Set params
    params.set("from", range.start.toString());
    params.set("to", range.end.toString());
  } else {
    // Trường hợp xóa chọn (null): Xóa params để reset về mặc định
    params.delete("from");
    params.delete("to");
  }

  router.replace(`${pathname}?${params.toString()}`);
};


  return (
    <div className="w-full sm:w-auto">
      <DateRangePicker
        label="Select Date Range"
        size="sm"
        variant="bordered"
        defaultValue={defaultValue}
        onChange={handleDateChange}
        className="max-w-xs"
        visibleMonths={2} 
      />
    </div>
  );
};

================
File: components/icons.tsx
================
import * as React from "react";

import { IconSvgProps } from "@/types";

export const Logo: React.FC<IconSvgProps> = ({
  size = 36,
  width,
  height,
  ...props
}) => (
  <svg
    fill="none"
    height={size || height}
    viewBox="0 0 32 32"
    width={size || width}
    {...props}
  >
    <path
      clipRule="evenodd"
      d="M17.6482 10.1305L15.8785 7.02583L7.02979 22.5499H10.5278L17.6482 10.1305ZM19.8798 14.0457L18.11 17.1983L19.394 19.4511H16.8453L15.1056 22.5499H24.7272L19.8798 14.0457Z"
      fill="currentColor"
      fillRule="evenodd"
    />
  </svg>
);

export const DiscordIcon: React.FC<IconSvgProps> = ({
  size = 24,
  width,
  height,
  ...props
}) => {
  return (
    <svg
      height={size || height}
      viewBox="0 0 24 24"
      width={size || width}
      {...props}
    >
      <path
        d="M14.82 4.26a10.14 10.14 0 0 0-.53 1.1 14.66 14.66 0 0 0-4.58 0 10.14 10.14 0 0 0-.53-1.1 16 16 0 0 0-4.13 1.3 17.33 17.33 0 0 0-3 11.59 16.6 16.6 0 0 0 5.07 2.59A12.89 12.89 0 0 0 8.23 18a9.65 9.65 0 0 1-1.71-.83 3.39 3.39 0 0 0 .42-.33 11.66 11.66 0 0 0 10.12 0q.21.18.42.33a10.84 10.84 0 0 1-1.71.84 12.41 12.41 0 0 0 1.08 1.78 16.44 16.44 0 0 0 5.06-2.59 17.22 17.22 0 0 0-3-11.59 16.09 16.09 0 0 0-4.09-1.35zM8.68 14.81a1.94 1.94 0 0 1-1.8-2 1.93 1.93 0 0 1 1.8-2 1.93 1.93 0 0 1 1.8 2 1.93 1.93 0 0 1-1.8 2zm6.64 0a1.94 1.94 0 0 1-1.8-2 1.93 1.93 0 0 1 1.8-2 1.92 1.92 0 0 1 1.8 2 1.92 1.92 0 0 1-1.8 2z"
        fill="currentColor"
      />
    </svg>
  );
};

export const TwitterIcon: React.FC<IconSvgProps> = ({
  size = 24,
  width,
  height,
  ...props
}) => {
  return (
    <svg
      height={size || height}
      viewBox="0 0 24 24"
      width={size || width}
      {...props}
    >
      <path
        d="M19.633 7.997c.013.175.013.349.013.523 0 5.325-4.053 11.461-11.46 11.461-2.282 0-4.402-.661-6.186-1.809.324.037.636.05.973.05a8.07 8.07 0 0 0 5.001-1.721 4.036 4.036 0 0 1-3.767-2.793c.249.037.499.062.761.062.361 0 .724-.05 1.061-.137a4.027 4.027 0 0 1-3.23-3.953v-.05c.537.299 1.16.486 1.82.511a4.022 4.022 0 0 1-1.796-3.354c0-.748.199-1.434.548-2.032a11.457 11.457 0 0 0 8.306 4.215c-.062-.3-.1-.611-.1-.923a4.026 4.026 0 0 1 4.028-4.028c1.16 0 2.207.486 2.943 1.272a7.957 7.957 0 0 0 2.556-.973 4.02 4.02 0 0 1-1.771 2.22 8.073 8.073 0 0 0 2.319-.624 8.645 8.645 0 0 1-2.019 2.083z"
        fill="currentColor"
      />
    </svg>
  );
};

export const GithubIcon: React.FC<IconSvgProps> = ({
  size = 24,
  width,
  height,
  ...props
}) => {
  return (
    <svg
      height={size || height}
      viewBox="0 0 24 24"
      width={size || width}
      {...props}
    >
      <path
        clipRule="evenodd"
        d="M12.026 2c-5.509 0-9.974 4.465-9.974 9.974 0 4.406 2.857 8.145 6.821 9.465.499.09.679-.217.679-.481 0-.237-.008-.865-.011-1.696-2.775.602-3.361-1.338-3.361-1.338-.452-1.152-1.107-1.459-1.107-1.459-.905-.619.069-.605.069-.605 1.002.07 1.527 1.028 1.527 1.028.89 1.524 2.336 1.084 2.902.829.091-.645.351-1.085.635-1.334-2.214-.251-4.542-1.107-4.542-4.93 0-1.087.389-1.979 1.024-2.675-.101-.253-.446-1.268.099-2.64 0 0 .837-.269 2.742 1.021a9.582 9.582 0 0 1 2.496-.336 9.554 9.554 0 0 1 2.496.336c1.906-1.291 2.742-1.021 2.742-1.021.545 1.372.203 2.387.099 2.64.64.696 1.024 1.587 1.024 2.675 0 3.833-2.33 4.675-4.552 4.922.355.308.675.916.675 1.846 0 1.334-.012 2.41-.012 2.737 0 .267.178.577.687.479C19.146 20.115 22 16.379 22 11.974 22 6.465 17.535 2 12.026 2z"
        fill="currentColor"
        fillRule="evenodd"
      />
    </svg>
  );
};

export const MoonFilledIcon = ({
  size = 24,
  width,
  height,
  ...props
}: IconSvgProps) => (
  <svg
    aria-hidden="true"
    focusable="false"
    height={size || height}
    role="presentation"
    viewBox="0 0 24 24"
    width={size || width}
    {...props}
  >
    <path
      d="M21.53 15.93c-.16-.27-.61-.69-1.73-.49a8.46 8.46 0 01-1.88.13 8.409 8.409 0 01-5.91-2.82 8.068 8.068 0 01-1.44-8.66c.44-1.01.13-1.54-.09-1.76s-.77-.55-1.83-.11a10.318 10.318 0 00-6.32 10.21 10.475 10.475 0 007.04 8.99 10 10 0 002.89.55c.16.01.32.02.48.02a10.5 10.5 0 008.47-4.27c.67-.93.49-1.519.32-1.79z"
      fill="currentColor"
    />
  </svg>
);

export const SunFilledIcon = ({
  size = 24,
  width,
  height,
  ...props
}: IconSvgProps) => (
  <svg
    aria-hidden="true"
    focusable="false"
    height={size || height}
    role="presentation"
    viewBox="0 0 24 24"
    width={size || width}
    {...props}
  >
    <g fill="currentColor">
      <path d="M19 12a7 7 0 11-7-7 7 7 0 017 7z" />
      <path d="M12 22.96a.969.969 0 01-1-.96v-.08a1 1 0 012 0 1.038 1.038 0 01-1 1.04zm7.14-2.82a1.024 1.024 0 01-.71-.29l-.13-.13a1 1 0 011.41-1.41l.13.13a1 1 0 010 1.41.984.984 0 01-.7.29zm-14.28 0a1.024 1.024 0 01-.71-.29 1 1 0 010-1.41l.13-.13a1 1 0 011.41 1.41l-.13.13a1 1 0 01-.7.29zM22 13h-.08a1 1 0 010-2 1.038 1.038 0 011.04 1 .969.969 0 01-.96 1zM2.08 13H2a1 1 0 010-2 1.038 1.038 0 011.04 1 .969.969 0 01-.96 1zm16.93-7.01a1.024 1.024 0 01-.71-.29 1 1 0 010-1.41l.13-.13a1 1 0 011.41 1.41l-.13.13a.984.984 0 01-.7.29zm-14.02 0a1.024 1.024 0 01-.71-.29l-.13-.14a1 1 0 011.41-1.41l.13.13a1 1 0 010 1.41.97.97 0 01-.7.3zM12 3.04a.969.969 0 01-1-.96V2a1 1 0 012 0 1.038 1.038 0 01-1 1.04z" />
    </g>
  </svg>
);

export const HeartFilledIcon = ({
  size = 24,
  width,
  height,
  ...props
}: IconSvgProps) => (
  <svg
    aria-hidden="true"
    focusable="false"
    height={size || height}
    role="presentation"
    viewBox="0 0 24 24"
    width={size || width}
    {...props}
  >
    <path
      d="M12.62 20.81c-.34.12-.9.12-1.24 0C8.48 19.82 2 15.69 2 8.69 2 5.6 4.49 3.1 7.56 3.1c1.82 0 3.43.88 4.44 2.24a5.53 5.53 0 0 1 4.44-2.24C19.51 3.1 22 5.6 22 8.69c0 7-6.48 11.13-9.38 12.12Z"
      fill="currentColor"
      strokeLinecap="round"
      strokeLinejoin="round"
      strokeWidth={1.5}
    />
  </svg>
);

export const SearchIcon = (props: IconSvgProps) => (
  <svg
    aria-hidden="true"
    fill="none"
    focusable="false"
    height="1em"
    role="presentation"
    viewBox="0 0 24 24"
    width="1em"
    {...props}
  >
    <path
      d="M11.5 21C16.7467 21 21 16.7467 21 11.5C21 6.25329 16.7467 2 11.5 2C6.25329 2 2 6.25329 2 11.5C2 16.7467 6.25329 21 11.5 21Z"
      stroke="currentColor"
      strokeLinecap="round"
      strokeLinejoin="round"
      strokeWidth="2"
    />
    <path
      d="M22 22L20 20"
      stroke="currentColor"
      strokeLinecap="round"
      strokeLinejoin="round"
      strokeWidth="2"
    />
  </svg>
);

================
File: components/main-layout.tsx
================
"use client";

import { useSidebar } from "@/components/sidebar-context";
import { Button } from "@heroui/button";
import { PanelLeftOpen } from "lucide-react";
import clsx from "clsx";
import { Breadcrumbs } from "@/components/breadcrumbs";

export const MainLayout = ({ children }: { children: React.ReactNode }) => {
  const { isOpen, toggleSidebar } = useSidebar();

  return (
    <div 
        className={clsx(
            "flex-1 min-h-screen bg-background transition-all duration-300 ease-in-out flex flex-col",
            isOpen ? "ml-64" : "ml-0" // Điều chỉnh lề trái
        )}
    >
        {!isOpen && (
            <div className="sticky top-0 z-40 w-full bg-background/80 backdrop-blur-md border-b border-divider px-4 h-14 flex items-center">
                <Button isIconOnly variant="light" size="sm" onPress={toggleSidebar}>
                    <PanelLeftOpen size={24} />
                </Button>
                <span className="ml-2 font-semibold text-default-600">DW Admin</span>
            </div>
        )}

        <main className="flex-1 p-8">
            <Breadcrumbs />
            {children}
        </main>
    </div>
  );
};

================
File: components/maintenance-panel.tsx
================
"use client";

import { useState } from "react";
import { Card, CardBody, CardHeader } from "@heroui/card";
import { Button } from "@heroui/button";
import { Input } from "@heroui/input";
import { Trash2Icon, AlertTriangleIcon } from "lucide-react";
import { purgeOldData } from "@/app/actions/settings";
import { Tooltip } from "@heroui/tooltip"; // Import Tooltip để thay thế thông báo alert

export default function MaintenancePanel() {
  const [rawDays, setRawDays] = useState("30");
  const [logDays, setLogDays] = useState("60");
  const [isLoadingRaw, setIsLoadingRaw] = useState(false);
  const [isLoadingLogs, setIsLoadingLogs] = useState(false);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);
  const [errorMessage, setErrorMessage] = useState<string | null>(null);

  const handlePurge = async (target: 'RAW' | 'LOGS') => {
    const days = target === 'RAW' ? Number(rawDays) : Number(logDays);
    const targetName = target === 'RAW' ? 'Dữ liệu Thô (Raw Data)' : 'Logs Hệ thống';

    setSuccessMessage(null);
    setErrorMessage(null);

    // Thay thế confirm() bằng window.confirm để giữ nguyên logic xác nhận nguy hiểm
    if (!window.confirm(`Bạn có chắc chắn muốn XÓA VĨNH VIỄN ${targetName} cũ hơn ${days} ngày không? Hành động này không thể hoàn tác.`)) {
      return;
    }

    if (target === 'RAW') setIsLoadingRaw(true);
    else setIsLoadingLogs(true);

    const res = await purgeOldData(days, target);

    if (res.success) {
      setSuccessMessage(`Đã xóa thành công ${res.count} bản ghi khỏi ${targetName}.`);
    } else {
      setErrorMessage(`Lỗi: Không thể xóa dữ liệu ${targetName}.`);
      console.error(`Lỗi xóa dữ liệu ${targetName}:`, res.error);
    }

    if (target === 'RAW') setIsLoadingRaw(false);
    else setIsLoadingLogs(false);
  };

  return (
    <Card className="border border-danger-100 dark:border-danger-900/30 font-sans">
      <CardHeader className="flex gap-3">
        <AlertTriangleIcon className="text-danger" />
        <div className="flex flex-col">
          <p className="text-md font-bold text-danger">Lưu Trữ & Bảo Trì Dữ Liệu</p>
          <p className="text-small text-default-500">Dọn dẹp dữ liệu cũ để tiết kiệm không gian lưu trữ.</p>
        </div>
      </CardHeader>
      <CardBody className="gap-6">

        {/* Messages */}
        {successMessage && (
          <div className="p-3 bg-success-50 border border-success-200 text-success-700 rounded-lg text-sm">
            {successMessage}
          </div>
        )}
        {errorMessage && (
          <div className="p-3 bg-danger-50 border border-danger-200 text-danger-700 rounded-lg text-sm">
            {errorMessage}
          </div>
        )}

        {/* Purge Raw Data */}
        <div className="flex items-end gap-4">
          <Input
            label="Xóa Dữ Liệu Thô (Raw Data) cũ hơn (ngày)"
            type="number"
            value={rawDays}
            onValueChange={setRawDays}
            variant="bordered"
            className="max-w-xs"
            placeholder="Số ngày"
          />
          <Tooltip content={"Xóa vĩnh viễn dữ liệu thô cũ hơn số ngày quy định."}>
            <Button
              color="danger"
              variant="flat"
              startContent={<Trash2Icon size={18} />}
              isLoading={isLoadingRaw}
              onPress={() => handlePurge('RAW')}
            >
              Dọn Dẹp Dữ Liệu Thô
            </Button>
          </Tooltip>
        </div>

        {/* Purge Logs */}
        <div className="flex items-end gap-4">
          <Input
            label="Xóa Logs Hệ thống cũ hơn (ngày)"
            type="number"
            value={logDays}
            onValueChange={setLogDays}
            variant="bordered"
            className="max-w-xs"
            placeholder="Số ngày"
          />
          <Tooltip content={"Xóa vĩnh viễn các bản ghi logs hệ thống cũ hơn số ngày quy định."}>
            <Button
              color="warning"
              variant="flat"
              startContent={<Trash2Icon size={18} />}
              isLoading={isLoadingLogs}
              onPress={() => handlePurge('LOGS')}
            >
              Dọn Dẹp Logs Hệ Thống
            </Button>
          </Tooltip>
        </div>
      </CardBody>
    </Card >
  );
}

================
File: components/primitives.ts
================
import { tv } from "tailwind-variants";

export const title = tv({
  base: "tracking-tight inline font-semibold",
  variants: {
    color: {
      violet: "from-[#FF1CF7] to-[#b249f8]",
      yellow: "from-[#FF705B] to-[#FFB457]",
      blue: "from-[#5EA2EF] to-[#0072F5]",
      cyan: "from-[#00b7fa] to-[#01cfea]",
      green: "from-[#6FEE8D] to-[#17c964]",
      pink: "from-[#FF72E1] to-[#F54C7A]",
      foreground: "dark:from-[#FFFFFF] dark:to-[#4B4B4B]",
    },
    size: {
      sm: "text-3xl lg:text-4xl",
      md: "text-[2.3rem] lg:text-5xl",
      lg: "text-4xl lg:text-6xl",
    },
    fullWidth: {
      true: "w-full block",
    },
  },
  defaultVariants: {
    size: "md",
  },
  compoundVariants: [
    {
      color: [
        "violet",
        "yellow",
        "blue",
        "cyan",
        "green",
        "pink",
        "foreground",
      ],
      class: "bg-clip-text text-transparent bg-gradient-to-b",
    },
  ],
});

export const subtitle = tv({
  base: "w-full md:w-1/2 my-2 text-lg lg:text-xl text-default-600 block max-w-full",
  variants: {
    fullWidth: {
      true: "!w-full",
    },
  },
  defaultVariants: {
    fullWidth: true,
  },
});

================
File: components/search-input.tsx
================
"use client";

import { Input } from "@heroui/input";
import { SearchIcon } from "lucide-react";
import { useSearchParams, usePathname, useRouter } from "next/navigation";
import { useDebouncedCallback } from "use-debounce";

export default function SearchInput({ placeholder }: { placeholder: string }) {
    const searchParams = useSearchParams();
    const pathname = usePathname();
    const { replace } = useRouter();

    const handleSearch = useDebouncedCallback((term: string) => {
        const params = new URLSearchParams(searchParams);
        params.set("page", "1");
        if (term) {
            params.set("query", term);
        } else {
            params.delete("query");
        }
        replace(`${pathname}?${params.toString()}`);
    }, 300);

    return (
        <Input
            classNames={{
                base: "max-w-full sm:max-w-[20rem] h-10",
                mainWrapper: "h-full",
                input: "text-small",
                inputWrapper: "h-full font-normal text-default-500 bg-default-400/20 dark:bg-default-500/20",
            }}
            placeholder={placeholder}
            size="sm"
            startContent={<SearchIcon size={18} />}
            type="search"
            defaultValue={searchParams.get("query")?.toString()}
            onChange={(e) => handleSearch(e.target.value)}
        />
    );
}

================
File: components/sidebar-context.tsx
================
"use client";

import React, { createContext, useContext, useEffect, useState } from "react";

interface SidebarContextType {
  isOpen: boolean;
  toggleSidebar: () => void;
}

const SidebarContext = createContext<SidebarContextType | undefined>(undefined);

export const SidebarProvider = ({ children }: { children: React.ReactNode }) => {
  // Mặc định là true (Mở) để khớp với Server Side Rendering ban đầu
  const [isOpen, setIsOpen] = useState(true);
  
  // Chúng ta bỏ state isMounted đi, hoặc nếu dùng thì không được return children trần
  
  useEffect(() => {
    // Chỉ chạy ở client: Lấy trạng thái từ localStorage
    const savedState = localStorage.getItem("sidebar_state");
    if (savedState !== null) {
      setIsOpen(savedState === "true");
    }
  }, []);

  const toggleSidebar = () => {
    const newState = !isOpen;
    setIsOpen(newState);
    localStorage.setItem("sidebar_state", String(newState));
  };

  return (
    <SidebarContext.Provider value={{ isOpen, toggleSidebar }}>
      {children}
    </SidebarContext.Provider>
  );
};

export const useSidebar = () => {
  const context = useContext(SidebarContext);
  if (!context) throw new Error("useSidebar must be used within a SidebarProvider");
  return context;
};

================
File: components/theme-switch.tsx
================
"use client";

import { FC } from "react";
import { VisuallyHidden } from "@react-aria/visually-hidden";
import { SwitchProps, useSwitch } from "@heroui/switch";
import { useTheme } from "next-themes";
import { useIsSSR } from "@react-aria/ssr";
import clsx from "clsx";

import { SunFilledIcon, MoonFilledIcon } from "@/components/icons";

export interface ThemeSwitchProps {
  className?: string;
  classNames?: SwitchProps["classNames"];
}

export const ThemeSwitch: FC<ThemeSwitchProps> = ({
  className,
  classNames,
}) => {
  const { theme, setTheme } = useTheme();
  const isSSR = useIsSSR();

  const onChange = () => {
    theme === "light" ? setTheme("dark") : setTheme("light");
  };

  const {
    Component,
    slots,
    isSelected,
    getBaseProps,
    getInputProps,
    getWrapperProps,
  } = useSwitch({
    isSelected: theme === "light" || isSSR,
    "aria-label": `Switch to ${theme === "light" || isSSR ? "dark" : "light"} mode`,
    onChange,
  });

  return (
    <Component
      {...getBaseProps({
        className: clsx(
          "px-px transition-opacity hover:opacity-80 cursor-pointer",
          className,
          classNames?.base,
        ),
      })}
    >
      <VisuallyHidden>
        <input {...getInputProps()} />
      </VisuallyHidden>
      <div
        {...getWrapperProps()}
        className={slots.wrapper({
          class: clsx(
            [
              "w-auto h-auto",
              "bg-transparent",
              "rounded-lg",
              "flex items-center justify-center",
              "group-data-[selected=true]:bg-transparent",
              "!text-default-500",
              "pt-px",
              "px-0",
              "mx-0",
            ],
            classNames?.wrapper,
          ),
        })}
      >
        {!isSelected || isSSR ? (
          <SunFilledIcon size={22} />
        ) : (
          <MoonFilledIcon size={22} />
        )}
      </div>
    </Component>
  );
};

================
File: config/site.ts
================
export type SiteConfig = typeof siteConfig;

export const siteConfig = {
  name: "Next.js + HeroUI",
  description: "Make beautiful websites regardless of your design experience.",
  navItems: [
    {
      label: "Home",
      href: "/",
    },
    {
      label: "Docs",
      href: "/docs",
    },
    {
      label: "Pricing",
      href: "/pricing",
    },
    {
      label: "Blog",
      href: "/blog",
    },
    {
      label: "About",
      href: "/about",
    },
  ],
  navMenuItems: [
    {
      label: "Profile",
      href: "/profile",
    },
    {
      label: "Dashboard",
      href: "/dashboard",
    },
    {
      label: "Projects",
      href: "/projects",
    },
    {
      label: "Team",
      href: "/team",
    },
    {
      label: "Calendar",
      href: "/calendar",
    },
    {
      label: "Settings",
      href: "/settings",
    },
    {
      label: "Help & Feedback",
      href: "/help-feedback",
    },
    {
      label: "Logout",
      href: "/logout",
    },
  ],
  links: {
    github: "https://github.com/heroui-inc/heroui",
    twitter: "https://twitter.com/hero_ui",
    docs: "https://heroui.com",
    discord: "https://discord.gg/9b6yyZKmH4",
    sponsor: "https://patreon.com/jrgarciadev",
  },
};

================
File: lib/prisma.ts
================
import { PrismaClient } from '@prisma/client';

const globalForPrisma = global as unknown as { prisma: PrismaClient };

export const prisma = globalForPrisma.prisma || new PrismaClient();

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;

================
File: lib/utils.ts
================
import { type ClassValue, clsx } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}

export function serializeData(data: any): any {
  return JSON.parse(
    JSON.stringify(data, (key, value) =>
      typeof value === "bigint" ? value.toString() : value
    )
  );
}

================
File: public/next.svg
================
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>

================
File: public/vercel.svg
================
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 283 64"><path fill="black" d="M141 16c-11 0-19 7-19 18s9 18 20 18c7 0 13-3 16-7l-7-5c-2 3-6 4-9 4-5 0-9-3-10-7h28v-3c0-11-8-18-19-18zm-9 15c1-4 4-7 9-7s8 3 9 7h-18zm117-15c-11 0-19 7-19 18s9 18 20 18c6 0 12-3 16-7l-8-5c-2 3-5 4-8 4-5 0-9-3-11-7h28l1-3c0-11-8-18-19-18zm-10 15c2-4 5-7 10-7s8 3 9 7h-19zm-39 3c0 6 4 10 10 10 4 0 7-2 9-5l8 5c-3 5-9 8-17 8-11 0-19-7-19-18s8-18 19-18c8 0 14 3 17 8l-8 5c-2-3-5-5-9-5-6 0-10 4-10 10zm83-29v46h-9V5h9zM37 0l37 64H0L37 0zm92 5-27 48L74 5h10l18 30 17-30h10zm59 12v10l-3-1c-6 0-10 4-10 10v15h-9V17h9v9c0-5 6-9 13-9z"/></svg>

================
File: styles/globals.css
================
@import "tailwindcss";

@config "../tailwind.config.js"

================
File: types/index.ts
================
import { SVGProps } from "react";

export type IconSvgProps = SVGProps<SVGSVGElement> & {
  size?: number;
};

================
File: .gitignore
================
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.js

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# local env files
.env*.local

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts

pnpm-lock.yaml
yarn.lock
package-lock.json
bun.lockb
/app/generated/prisma

================
File: .npmrc
================
public-hoist-pattern[]=*@heroui/*
package-lock=true

================
File: eslint.config.mjs
================
import { defineConfig, globalIgnores } from "eslint/config";
import { fixupConfigRules, fixupPluginRules } from "@eslint/compat";
import react from "eslint-plugin-react";
import unusedImports from "eslint-plugin-unused-imports";
import _import from "eslint-plugin-import";
import typescriptEslint from "@typescript-eslint/eslint-plugin";
import jsxA11Y from "eslint-plugin-jsx-a11y";
import prettier from "eslint-plugin-prettier";
import globals from "globals";
import tsParser from "@typescript-eslint/parser";
import path from "node:path";
import { fileURLToPath } from "node:url";
import js from "@eslint/js";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const compat = new FlatCompat({
    baseDirectory: __dirname,
    recommendedConfig: js.configs.recommended,
    allConfig: js.configs.all
});

export default defineConfig([globalIgnores([
    ".now/*",
    "**/*.css",
    "**/.changeset",
    "**/dist",
    "esm/*",
    "public/*",
    "tests/*",
    "scripts/*",
    "**/*.config.js",
    "**/.DS_Store",
    "**/node_modules",
    "**/coverage",
    "**/.next",
    "**/build",
    "!**/.commitlintrc.cjs",
    "!**/.lintstagedrc.cjs",
    "!**/jest.config.js",
    "!**/plopfile.js",
    "!**/react-shim.js",
    "!**/tsup.config.ts",
]), {
    extends: fixupConfigRules(compat.extends(
        "plugin:react/recommended",
        "plugin:prettier/recommended",
        "plugin:react-hooks/recommended",
        "plugin:jsx-a11y/recommended",
        "plugin:@next/next/recommended",
    )),

    plugins: {
        react: fixupPluginRules(react),
        "unused-imports": unusedImports,
        import: fixupPluginRules(_import),
        "@typescript-eslint": typescriptEslint,
        "jsx-a11y": fixupPluginRules(jsxA11Y),
        prettier: fixupPluginRules(prettier),
    },

    languageOptions: {
        globals: {
            ...Object.fromEntries(Object.entries(globals.browser).map(([key]) => [key, "off"])),
            ...globals.node,
        },

        parser: tsParser,
        ecmaVersion: 12,
        sourceType: "module",

        parserOptions: {
            ecmaFeatures: {
                jsx: true,
            },
        },
    },

    settings: {
        react: {
            version: "detect",
        },
    },

    files: ["**/*.ts", "**/*.tsx"],

    rules: {
        "no-console": "warn",
        "react/prop-types": "off",
        "react/jsx-uses-react": "off",
        "react/react-in-jsx-scope": "off",
        "react-hooks/exhaustive-deps": "off",
        "jsx-a11y/click-events-have-key-events": "warn",
        "jsx-a11y/interactive-supports-focus": "warn",
        "prettier/prettier": "warn",
        "no-unused-vars": "off",
        "unused-imports/no-unused-vars": "off",
        "unused-imports/no-unused-imports": "warn",

        "@typescript-eslint/no-unused-vars": ["warn", {
            args: "after-used",
            ignoreRestSiblings: false,
            argsIgnorePattern: "^_.*?$",
        }],

        "import/order": ["warn", {
            groups: [
                "type",
                "builtin",
                "object",
                "external",
                "internal",
                "parent",
                "sibling",
                "index",
            ],

            pathGroups: [{
                pattern: "~/**",
                group: "external",
                position: "after",
            }],

            "newlines-between": "always",
        }],

        "react/self-closing-comp": "warn",

        "react/jsx-sort-props": ["warn", {
            callbacksLast: true,
            shorthandFirst: true,
            noSortAlphabetically: false,
            reservedFirst: true,
        }],

        "padding-line-between-statements": ["warn", {
            blankLine: "always",
            prev: "*",
            next: "return",
        }, {
            blankLine: "always",
            prev: ["const", "let", "var"],
            next: "*",
        }, {
            blankLine: "any",
            prev: ["const", "let", "var"],
            next: ["const", "let", "var"],
        }],
    },
}]);

================
File: LICENSE
================
MIT License

Copyright (c) 2023 Next UI

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

================
File: next.config.js
================
/** @type {import('next').NextConfig} */
const nextConfig = {};

module.exports = nextConfig;

================
File: postcss.config.js
================
module.exports = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
}

================
File: prisma.config.ts
================
// This file was generated by Prisma and assumes you have installed the following:
// npm install --save-dev prisma dotenv
import "dotenv/config";
import { defineConfig, env } from "prisma/config";

export default defineConfig({
  schema: "prisma/schema.prisma",
  migrations: {
    path: "prisma/migrations",
  },
  datasource: {
    url: env("DATABASE_URL"),
  },
});

================
File: README.md
================
# Next.js & HeroUI Template

This is a template for creating applications using Next.js 14 (app directory) and HeroUI (v2).

[Try it on CodeSandbox](https://githubbox.com/heroui-inc/heroui/next-app-template)

## Technologies Used

- [Next.js 14](https://nextjs.org/docs/getting-started)
- [HeroUI v2](https://heroui.com/)
- [Tailwind CSS](https://tailwindcss.com/)
- [Tailwind Variants](https://tailwind-variants.org)
- [TypeScript](https://www.typescriptlang.org/)
- [Framer Motion](https://www.framer.com/motion/)
- [next-themes](https://github.com/pacocoursey/next-themes)

## How to Use

### Use the template with create-next-app

To create a new project based on this template using `create-next-app`, run the following command:

```bash
npx create-next-app -e https://github.com/heroui-inc/next-app-template
```

### Install dependencies

You can use one of them `npm`, `yarn`, `pnpm`, `bun`, Example using `npm`:

```bash
npm install
```

### Run the development server

```bash
npm run dev
```

### Setup pnpm (optional)

If you are using `pnpm`, you need to add the following code to your `.npmrc` file:

```bash
public-hoist-pattern[]=*@heroui/*
```

After modifying the `.npmrc` file, you need to run `pnpm install` again to ensure that the dependencies are installed correctly.

## License

Licensed under the [MIT license](https://github.com/heroui-inc/next-app-template/blob/main/LICENSE).

================
File: tsconfig.json
================
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}

================
File: app/actions/settings.ts
================
"use server";

import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";

// Định nghĩa các cài đặt mặc định của hệ thống
const DEFAULT_SETTINGS = [
  { key: "DQ_PENALTY_WEIGHT", value: "0.5", type: "number", group: "DATA_QUALITY", description: "Điểm trừ cho mỗi lỗi (Severity Low/Medium)" },
  { key: "DQ_CRITICAL_WEIGHT", value: "2.0", type: "number", group: "DATA_QUALITY", description: "Hệ số nhân điểm trừ cho lỗi nghiêm trọng (Critical)" },
  { key: "DQ_STALE_HOURS", value: "24", type: "number", group: "DATA_QUALITY", description: "Số giờ tối đa chấp nhận dữ liệu cũ trước khi báo lỗi Stale Data" },
  { key: "DASHBOARD_DAYS_LOOKBACK", value: "7", type: "number", group: "GENERAL", description: "Số ngày mặc định hiển thị trên biểu đồ Dashboard" },
  { 
    key: "JOB_STUCK_THRESHOLD_MINUTES", 
    value: "60", 
    type: "number", 
    group: "CRAWLER", 
    description: "Nếu Job chạy quá số phút này mà chưa xong, coi như bị treo (Stuck) để cho phép chạy lại." 
  },
  { key: "MAINTENANCE_MODE", value: "false", type: "boolean", group: "GENERAL", description: "Bật chế độ bảo trì hệ thống" },
];

// 1. Lấy tất cả settings (Kèm logic tự động Seed nếu chưa có)
export async function getAllSettings() {
  try {
    let settings = await prisma.system_settings.findMany({
      orderBy: [{ group: 'asc' }, { key: 'asc' }]
    });

    // Nếu DB chưa có gì, tự động thêm Default vào
    if (settings.length === 0) {
      console.log("Seeding default settings...");
      await prisma.system_settings.createMany({
        data: DEFAULT_SETTINGS,
        skipDuplicates: true
      });
      settings = await prisma.system_settings.findMany({
        orderBy: [{ group: 'asc' }, { key: 'asc' }]
      });
    }

    return { success: true, data: settings };
  } catch (error) {
    console.error("Fetch settings error:", error);
    return { error: "Failed to fetch settings" };
  }
}

// 2. Cập nhật Setting
export async function updateSetting(key: string, value: string) {
  try {
    await prisma.system_settings.update({
      where: { key },
      data: { 
        value, 
        updated_at: new Date() 
      }
    });
    revalidatePath("/settings");
    revalidatePath("/data-quality"); // Refresh các trang có dùng config
    revalidatePath("/");
    return { success: true };
  } catch (error) {
    return { error: "Failed to update setting" };
  }
}

// 3. Helper lấy config dùng trong code (Server-side only)
export async function getConfig<T>(key: string, defaultValue: T): Promise<T> {
  const setting = await prisma.system_settings.findUnique({
    where: { key }
  });

  if (!setting) return defaultValue;

  if (setting.type === 'number') return Number(setting.value) as T;
  if (setting.type === 'boolean') return (setting.value === 'true') as T;
  
  return setting.value as T;
}

export async function purgeOldData(retentionDays: number, target: 'RAW' | 'LOGS') {
  try {
    const dateThreshold = new Date();
    dateThreshold.setDate(dateThreshold.getDate() - retentionDays);

    let deletedCount = 0;

    if (target === 'RAW') {
      const res = await prisma.tbl_products_raw.deleteMany({
        where: { load_timestamp: { lt: dateThreshold } }
      });
      deletedCount = res.count;
    } 
    else if (target === 'LOGS') {
      const res = await prisma.crawled_files_log.deleteMany({
        where: { created_at: { lt: dateThreshold } }
      });
      deletedCount = res.count;
    }

    revalidatePath("/system-health");
    return { success: true, count: deletedCount };
  } catch (error) {
    console.error("Purge error:", error);
    return { error: "Failed to purge data" };
  }
}

================
File: app/dictionary/page.tsx
================
import { getDictionaryData } from "@/app/actions/dictionary";
import DictionaryEditor from "@/components/dictionary-editor";

export default async function DictionaryPage() {
  const result = await getDictionaryData();

  if (result.error || !result.data) {
    return (
      <div className="flex items-center justify-center h-full text-lg text-danger-600 font-semibold bg-danger-50 border border-danger-200 rounded-lg p-6">
        Lỗi khi tải dữ liệu từ điển.
      </div>
    );
  }

  return (
    <div className="h-full">
      <DictionaryEditor initialData={result.data} />
    </div>
  );
}

================
File: app/raw-data/page.tsx
================
import { prisma } from "@/lib/prisma";
import { RawDataTable } from "@/components/raw-data-table";
import { serializeData } from "@/lib/utils";

const ITEMS_PER_PAGE = 10;

export default async function RawDataPage({
  searchParams,
}: {
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>;
}) {
  const params = await searchParams;
  const page = Number(params?.page) || 1;
  const skip = (page - 1) * ITEMS_PER_PAGE;

  const [products, totalCount] = await prisma.$transaction([
    prisma.tbl_products_raw.findMany({
      skip,
      take: ITEMS_PER_PAGE,
      orderBy: { id: 'desc' },
      select: {
        id: true,
        product_id: true,
        source_file_name: true,
        load_timestamp: true,
        raw_data: true,
      }
    }),
    prisma.tbl_products_raw.count()
  ]);

  const totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE);
  
  const serializedProducts = serializeData(products);

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold">Dữ Liệu Sản Phẩm Thô (Raw Data)</h1>
        <div className="text-small text-default-500">
            Tổng cộng: {new Intl.NumberFormat('vi-VN').format(totalCount)} bản ghi
        </div>
      </div>
      <RawDataTable data={serializedProducts} totalPages={totalPages} />
    </div>
  );
}

================
File: app/reviews/page.tsx
================
import { prisma } from "@/lib/prisma";
import { Card, CardBody, CardHeader } from "@heroui/card";
import { serializeData } from "@/lib/utils";
import { MessageSquareWarningIcon } from "lucide-react";
import { RatingPieChart } from "@/components/rating-pie-chart";
import { NegativeReviewsTable } from "@/components/negative-reviews-table";

async function getReviewData() {
  // 1. Lấy phân bố rating (GROUP BY rating)
  const ratingDistributionRaw: any[] = await prisma.$queryRaw`
    SELECT 
      rating, 
      COUNT(*)::int as count 
    FROM "warehouse"."fact_reviews"
    WHERE rating IS NOT NULL
    GROUP BY rating
    ORDER BY rating ASC
  `;

  // Map lại dữ liệu cho biểu đồ (đảm bảo đủ 1-5 sao)
  const ratingMap = new Map(ratingDistributionRaw.map(r => [r.rating, r.count]));
  const chartData = [1, 2, 3, 4, 5].map(star => ({
    rating: `${star} Sao`, // Dịch chuỗi hiển thị
    count: ratingMap.get(star) || 0
  }));

  // 2. Lấy 10 đánh giá tiêu cực gần nhất (1-2 sao)
  const negativeReviews = await prisma.fact_reviews.findMany({
    where: {
      rating: { lte: 2 } // Nhỏ hơn hoặc bằng 2 sao
    },
    take: 10,
    orderBy: { review_timestamp: 'desc' },
    include: {
      dim_shop: { select: { shop_name: true } },
      dim_sku: {
        include: {
            dim_product: { select: { title: true } }
        }
      }
    }
  });

  return {
    chartData,
    negativeReviews: serializeData(negativeReviews)
  };
}

export default async function ReviewsPage() {
  const data = await getReviewData();

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold">Ý Kiến & Đánh Giá Khách Hàng</h1>
      
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Cột trái: Biểu đồ */}
        <div className="lg:col-span-1">
             <RatingPieChart data={data.chartData} />
        </div>

        {/* Cột phải: Danh sách cảnh báo */}
        <div className="lg:col-span-2">
            <Card className="h-full min-h-[350px]">
                <CardHeader className="flex gap-3">
                    <MessageSquareWarningIcon className="text-danger" />
                    <div className="flex flex-col">
                        <p className="text-md font-bold">Các Đánh Giá Tiêu Cực Gần Đây</p>
                        <p className="text-small text-default-500">Cảnh báo cho các đánh giá 1-2 sao</p>
                    </div>
                </CardHeader>
                <CardBody>
                    <NegativeReviewsTable reviews={data.negativeReviews} />
                </CardBody>
            </Card>
        </div>
      </div>
    </div>
  );
}

================
File: app/shops/page.tsx
================
import { prisma } from "@/lib/prisma";
import { ShopsTable } from "@/components/shops-table";
import SearchInput from "@/components/search-input"; // Tái sử dụng component search cũ
import { serializeData } from "@/lib/utils";

const ITEMS_PER_PAGE = 10;

export default async function ShopsPage({
  searchParams,
}: {
  searchParams: Promise<{ query?: string; page?: string }>;
}) {
  const params = await searchParams;
  const query = params?.query || "";
  const page = Number(params?.page) || 1;
  const skip = (page - 1) * ITEMS_PER_PAGE;

  // Điều kiện lọc
  const whereCondition = query
    ? {
        OR: [
          { shop_name: { contains: query, mode: "insensitive" as const } },
          { seller_id: { contains: query, mode: "insensitive" as const } },
        ],
      }
    : {};

  const [shops, totalCount] = await prisma.$transaction([
    prisma.tbl_base_shop_info.findMany({
      where: whereCondition,
      skip,
      take: ITEMS_PER_PAGE,
      orderBy: { followers_count: "desc" }, // Sắp xếp mặc định theo follower
    }),
    prisma.tbl_base_shop_info.count({ where: whereCondition }),
  ]);

  const totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE);
  const serializedShops = serializeData(shops);

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold">Danh Mục Cửa Hàng</h1>
        <SearchInput placeholder="Tìm kiếm tên cửa hàng..." />
      </div>
      <ShopsTable shops={serializedShops} totalPages={totalPages} />
    </div>
  );
}

================
File: app/system-health/page.tsx
================
import { getDatabaseHealth } from "@/app/actions/system";
import { Card, CardBody, CardHeader } from "@heroui/card";
import { Progress } from "@heroui/progress";
import { DatabaseIcon, HardDriveIcon, ZapIcon } from "lucide-react";
import { SlowQueriesTable } from "@/components/slow-queries-table";

export default async function SystemHealthPage() {
  const data = await getDatabaseHealth();

  if (!data) return <div className="flex items-center justify-center h-full text-lg text-danger-600 font-semibold bg-danger-50 border border-danger-200 rounded-lg p-6">Lỗi khi tải thống kê sức khỏe cơ sở dữ liệu.</div>;

  const maxBytes = Math.max(...data.tableStats.map((t: any) => t.total_bytes));

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold flex items-center gap-2">
        Sức Khỏe Hạ Tầng Cơ Sở Dữ Liệu
      </h1>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <Card className="bg-primary-50 dark:bg-primary-900/20">
            <CardBody className="flex flex-row items-center gap-4">
                <div className="p-3 bg-primary/20 rounded-full text-primary">
                    <DatabaseIcon size={24} />
                </div>
                <div>
                    <p className="text-sm text-default-500 font-semibold">Tổng Kích Thước DB</p>
                    <h2 className="text-3xl font-bold">{data.dbSize}</h2>
                </div>
            </CardBody>
        </Card>

        <Card className="bg-success-50 dark:bg-success-900/20">
            <CardBody className="flex flex-row items-center gap-4">
                <div className="p-3 bg-success/20 rounded-full text-success">
                    <ZapIcon size={24} />
                </div>
                <div>
                    <p className="text-sm text-default-500 font-semibold">Tỷ Lệ Cache Hit</p>
                    <h2 className="text-3xl font-bold">{data.cacheHitRatio.toFixed(2)}%</h2>
                    <p className="text-xs text-default-400">Mục tiêu: &gt; 99%</p>
                </div>
            </CardBody>
        </Card>

        <Card className="bg-warning-50 dark:bg-warning-900/20">
            <CardBody className="flex flex-row items-center gap-4">
                <div className="p-3 bg-warning/20 rounded-full text-warning">
                    <HardDriveIcon size={24} />
                </div>
                <div>
                    <p className="text-sm text-default-500 font-semibold">Bảng Dữ Liệu Lớn</p>
                    <h2 className="text-3xl font-bold">{data.tableStats.length}</h2>
                    <p className="text-xs text-default-400">Bảng đang được giám sát</p>
                </div>
            </CardBody>
        </Card>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <Card className="min-h-[400px]">
            <CardHeader>
                <h3 className="font-semibold text-lg">Các Bảng Lớn Nhất</h3>
            </CardHeader>
            <CardBody>
                <div className="flex flex-col gap-4">
                    {data.tableStats.map((table: any) => (
                        <div key={table.table_name} className="flex flex-col gap-1">
                            <div className="flex justify-between text-sm">
                                <span className="font-medium">{table.table_name}</span>
                                <span className="text-default-500">{table.total_size}</span>
                            </div>
                            <Progress 
                                value={(table.total_bytes / maxBytes) * 100} 
                                color="primary" 
                                size="sm"
                                aria-label="Kích Thước Bảng"
                            />
                            <div className="text-tiny text-default-400">
                                {new Intl.NumberFormat('vi-VN').format(table.row_count)} dòng
                            </div>
                        </div>
                    ))}
                </div>
            </CardBody>
        </Card>

        <Card className="min-h-[400px]">
            <CardHeader>
                <h3 className="font-semibold text-lg">Cảnh Báo Hiệu Năng (Full Scans)</h3>
            </CardHeader>
            <CardBody>
                <SlowQueriesTable data={data.indexUsage} />
                
                <div className="mt-4 p-3 bg-default-100 rounded-lg text-xs text-default-500">
                    <strong>Mẹo:</strong> Nếu "Full Scans" cao (hàng nghìn) so với "Index Scans", hãy cân nhắc thêm INDEX (chỉ mục) vào bảng đó để tăng tốc độ truy vấn.
                </div>
            </CardBody>
        </Card>
      </div>
    </div>
  );
}

================
File: app/error.tsx
================
"use client";

import { useEffect } from "react";

export default function Error({
  error,
  reset,
}: {
  error: Error;
  reset: () => void;
}) {
  useEffect(() => {
    // Log the error to an error reporting service
    console.error(error);
  }, [error]);

  return (
    <div className="flex flex-col items-center justify-center h-full gap-4 p-8 bg-default-50 rounded-lg border border-danger-200">
      <h2 className="text-xl font-bold text-danger-600">Đã xảy ra lỗi!</h2>
      <p className="text-default-500 text-sm">Vui lòng thử tải lại trang.</p>
      <button
        className="px-4 py-2 bg-primary text-white font-semibold rounded-lg shadow-md hover:bg-primary-600 transition-colors"
        onClick={
          // Attempt to recover by trying to re-render the segment
          () => reset()
        }
      >
        Thử lại
      </button>
    </div>
  );
}

================
File: components/analytics-tables.tsx
================
"use client";

import { Table, TableHeader, TableColumn, TableBody, TableRow, TableCell } from "@heroui/table";

// Component hiển thị bảng Top Products
export const TopProductsTable = ({ products }: { products: any[] }) => {
  return (
    <Table aria-label="Top sản phẩm" removeWrapper className="font-sans">
      <TableHeader>
        <TableColumn>SẢN PHẨM</TableColumn>
        <TableColumn>CỬA HÀNG</TableColumn>
        <TableColumn>SỐ LƯỢNG ĐÃ BÁN</TableColumn>
        <TableColumn>GIÁ BÁN</TableColumn>
      </TableHeader>
      <TableBody emptyContent="Không có dữ liệu">
        {products.map((item: any, index: number) => (
          <TableRow key={index}>
            <TableCell>
              <div className="w-[150px] truncate" title={item.dim_product?.title}>
                {item.dim_product?.title || item.dim_product?.product_id}
              </div>
            </TableCell>
            <TableCell>{item.dim_shop?.shop_name || "N/A"}</TableCell>
            <TableCell className="font-bold">
              {new Intl.NumberFormat("vi-VN").format(item.sold_count)}
            </TableCell>
            <TableCell>
              {new Intl.NumberFormat("vi-VN", {
                style: "currency",
                currency: "VND",
              }).format(item.price_sale)}
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  );
};

// Component hiển thị bảng Top Shops
export const TopShopsTable = ({ shops }: { shops: any[] }) => {
  return (
    <Table aria-label="Top cửa hàng" removeWrapper className="font-sans">
      <TableHeader>
        <TableColumn>TÊN CỬA HÀNG</TableColumn>
        <TableColumn>TỔNG SỐ LƯỢNG ĐÃ BÁN</TableColumn>
        <TableColumn>DOANH THU ƯỚC TÍNH</TableColumn>
      </TableHeader>
      <TableBody emptyContent="Không có dữ liệu">
        {shops.map((item: any, index: number) => (
          <TableRow key={index}>
            <TableCell className="font-semibold">{item.shop_name}</TableCell>
            <TableCell>
              {new Intl.NumberFormat("vi-VN").format(item.total_sold)}
            </TableCell>
            <TableCell className="text-success font-bold">
              {new Intl.NumberFormat("vi-VN", {
                style: "currency",
                currency: "VND",
              }).format(item.revenue)}
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  );
};

================
File: components/command-palette.tsx
================
"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { Modal, ModalContent, ModalBody } from "@heroui/modal";
import { Input } from "@heroui/input";
import { Kbd } from "@heroui/kbd";
import { Listbox, ListboxItem } from "@heroui/listbox";
import { 
  SearchIcon, 
  HomeIcon,
  ActivityIcon,
  FileTextIcon,
  ServerIcon,
  DatabaseIcon,
  PackageSearchIcon,
  StoreIcon,
  BarChart3Icon,
  MessageSquareIcon,
  TerminalIcon,
  ShieldCheckIcon,
  BookOpenIcon,
  SettingsIcon
} from "lucide-react";

// Định nghĩa danh sách các trang khớp với Sidebar
const APP_ROUTES = [
  // 1. Monitoring (Giám sát)
  { id: "home", title: "Tổng Quan Dashboard", href: "/", icon: HomeIcon, section: "Giám sát (Monitoring)" },
  { id: "logs", title: "Lịch Sử Crawl", href: "/logs", icon: FileTextIcon, section: "Giám sát (Monitoring)" },

  // 2. Controller (Điều khiển)
  { id: "sources", title: "Cấu Hình Nguồn Dữ Liệu", href: "/sources", icon: ServerIcon, section: "Điều khiển (Controller)" },

  // 3. Staging Data (Dữ liệu Tạm)
  { id: "raw", title: "Dữ Liệu Thô (Raw Data)", href: "/raw-data", icon: DatabaseIcon, section: "Dữ liệu Tạm (Staging)" },
  { id: "products", title: "Sản Phẩm Đã Làm Sạch", href: "/products", icon: PackageSearchIcon, section: "Dữ liệu Tạm (Staging)" },
  { id: "shops", title: "Danh Mục Cửa Hàng", href: "/shops", icon: StoreIcon, section: "Dữ liệu Tạm (Staging)" },

  // 4. Warehouse (Kho Dữ Liệu)
  { id: "analytics", title: "Phân Tích Bán Hàng", href: "/analytics", icon: BarChart3Icon, section: "Kho Dữ Liệu (Warehouse)" },
  { id: "reviews", title: "Đánh Giá Khách Hàng", href: "/reviews", icon: MessageSquareIcon, section: "Kho Dữ Liệu (Warehouse)" },

  // 5. Engineering Tools (Công cụ Kỹ thuật)
  { id: "playground", title: "SQL Sandbox", href: "/playground", icon: TerminalIcon, section: "Công cụ Kỹ thuật" },
  { id: "quality", title: "Chất Lượng Dữ Liệu (DQ)", href: "/data-quality", icon: ShieldCheckIcon, section: "Công cụ Kỹ thuật" },
  { id: "health", title: "Sức Khỏe Hệ Thống", href: "/system-health", icon: ActivityIcon, section: "Công cụ Kỹ thuật" },
  { id: "dictionary", title: "Từ Điển Dữ Liệu", href: "/dictionary", icon: BookOpenIcon, section: "Công cụ Kỹ thuật" },
  { id: "settings", title: "Cấu Hình Hệ Thống", href: "/settings", icon: SettingsIcon, section: "Công cụ Kỹ thuật" },
];

export const CommandPalette = () => {
  const [isOpen, setIsOpen] = useState(false);
  const [query, setQuery] = useState("");
  const router = useRouter();

  // 1. Lắng nghe sự kiện Ctrl+K hoặc Cmd+K
  useEffect(() => {
    const down = (e: KeyboardEvent) => {
      if (e.key === "k" && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        setIsOpen((open) => !open);
      }
    };
    document.addEventListener("keydown", down);
    return () => document.removeEventListener("keydown", down);
  }, []);

  // 2. Filter danh sách dựa trên từ khóa
  const filteredItems = APP_ROUTES.filter((item) =>
    item.title.toLowerCase().includes(query.toLowerCase()) || 
    item.section.toLowerCase().includes(query.toLowerCase())
  );

  // 3. Xử lý chọn menu
  const handleSelect = (href: string) => {
    setIsOpen(false);
    setQuery("");
    router.push(href);
  };

  return (
    <>
      {/* Nút Trigger trên Sidebar */}
      <div 
        className="hidden md:flex items-center gap-2 cursor-pointer bg-default-100 hover:bg-default-200 px-3 py-1.5 rounded-lg transition-colors border border-default-200 mb-2 font-sans"
        onClick={() => setIsOpen(true)}
      >
        <SearchIcon size={14} className="text-default-500"/>
        <span className="text-small text-default-500 flex-1">Tìm kiếm...</span>
        <Kbd keys={["command"]}>K</Kbd>
      </div>

      <Modal 
        isOpen={isOpen} 
        onOpenChange={setIsOpen} 
        placement="top"
        hideCloseButton
        backdrop="blur"
        classNames={{
            base: "bg-content1 dark:bg-content1 border border-default-200 shadow-xl mt-20",
            body: "p-0",
        }}
        size="lg"
        scrollBehavior="inside"
      >
        <ModalContent className="font-sans">
          <ModalBody>
            {/* Input Search */}
            <Input
              autoFocus
              placeholder="Gõ để tìm kiếm trang..."
              value={query}
              onValueChange={setQuery}
              startContent={<SearchIcon size={18} className="text-default-400" />}
              classNames={{
                inputWrapper: "h-14 shadow-none border-b border-default-100 bg-transparent rounded-none",
                input: "text-medium",
              }}
            />

            {/* Result List */}
            <div className="max-h-[300px] overflow-y-auto px-2 pb-2">
                {filteredItems.length === 0 ? (
                    <div className="py-8 text-center text-default-500 text-sm">
                        Không tìm thấy kết quả nào cho "{query}"
                    </div>
                ) : (
                    <Listbox 
                        aria-label="Navigation" 
                        onAction={(key) => handleSelect(key as string)}
                        variant="flat"
                    >
                        {filteredItems.map((item) => (
                            <ListboxItem
                                key={item.href}
                                startContent={<item.icon size={18} className="text-default-400" />}
                                description={item.section}
                                classNames={{
                                    base: "py-3 rounded-lg data-[hover=true]:bg-default-100",
                                    title: "font-semibold",
                                    description: "text-tiny text-primary"
                                }}
                            >
                                {item.title}
                            </ListboxItem>
                        ))}
                    </Listbox>
                )}
            </div>
            
            {/* Footer hint */}
            <div className="bg-default-50 px-4 py-2 text-tiny text-default-400 flex justify-between border-t border-default-100 items-center">
                <span>Chọn để điều hướng</span>
                <div className="flex gap-2">
                    <span className="flex items-center gap-1"><Kbd >↑</Kbd><Kbd >↓</Kbd></span>
                    <span className="flex items-center gap-1"><Kbd >esc</Kbd> đóng</span>
                </div>
            </div>
          </ModalBody>
        </ModalContent>
      </Modal>
    </>
  );
};

================
File: components/create-source-modal.tsx
================
"use client";

import { PlusIcon } from "lucide-react";
import { createSource } from "@/app/actions/sources";
import { useState } from "react";
import { Button } from "@heroui/button";
import {Modal, ModalBody, ModalContent, ModalFooter, ModalHeader, useDisclosure} from '@heroui/modal'
import {Input} from '@heroui/input'
import {Checkbox} from '@heroui/checkbox'

export const CreateSourceModal = () => {
  const { isOpen, onOpen, onOpenChange, onClose } = useDisclosure();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState("");

  const handleSubmit = async (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    setIsLoading(true);
    setError("");

    const formData = new FormData(event.currentTarget);
    const result = await createSource(formData);

    setIsLoading(false);

    if (result.error) {
      setError(result.error);
    } else {
      onClose();
    }
  };

  return (
    <>
      <Button onPress={onOpen} color="primary" startContent={<PlusIcon size={18} />} className="font-sans">
        Thêm Nguồn Dữ Liệu
      </Button>

      <Modal isOpen={isOpen} onOpenChange={onOpenChange} placement="top-center">
        <ModalContent className="font-sans">
          {(onClose) => (
            <form onSubmit={handleSubmit}>
              <ModalHeader className="flex flex-col gap-1">Thêm Cấu Hình Nguồn Mới</ModalHeader>
              <ModalBody>
                {error && <div className="text-danger text-sm">{error}</div>}
                
                <Input
                  autoFocus
                  label="Tên Nguồn"
                  name="source_name"
                  placeholder="Ví dụ: Shopee Thiết Bị Điện Tử"
                  variant="bordered"
                  isRequired
                />
                <Input
                  label="URL Gốc (Base URL)"
                  name="base_url"
                  placeholder="https://shopee.vn/..."
                  variant="bordered"
                  isRequired
                />
                <div className="flex py-2 px-1 justify-between">
                  <Checkbox name="is_active" defaultSelected value="true">
                    Đang Hoạt Động
                  </Checkbox>
                </div>
              </ModalBody>
              <ModalFooter>
                <Button color="danger" variant="flat" onPress={onClose}>
                  Hủy Bỏ
                </Button>
                <Button color="primary" type="submit" isLoading={isLoading}>
                  Lưu Cấu Hình
                </Button>
              </ModalFooter>
            </form>
          )}
        </ModalContent>
      </Modal>
    </>
  );
};

================
File: components/dashboard-chart.tsx
================
"use client";

import {
    AreaChart,
    Area,
    XAxis,
    YAxis,
    CartesianGrid,
    Tooltip,
    ResponsiveContainer,
} from "recharts";
import { Card, CardBody, CardHeader } from "@heroui/card";

interface ChartData {
    date: string;
    count: number;
}

export const DashboardChart = ({ data }: { data: ChartData[] }) => {
    return (
        <Card className="lg:col-span-2 min-h-[400px] font-sans">
            <CardHeader>
                <h3 className="font-semibold text-lg">Số Lượng Sản Phẩm Thu Thập Được (7 Ngày Gần Nhất)</h3>
            </CardHeader>
            <CardBody>
                <div className="w-full h-[300px]">
                    <ResponsiveContainer width="100%" height="100%">
                        <AreaChart
                            data={data}
                            margin={{
                                top: 10,
                                right: 30,
                                left: 0,
                                bottom: 0,
                            }}
                        >
                            <defs>
                                <linearGradient id="colorCount" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#006FEE" stopOpacity={0.8} />
                                    <stop offset="95%" stopColor="#006FEE" stopOpacity={0} />
                                </linearGradient>
                            </defs>
                            <CartesianGrid strokeDasharray="3 3" stroke="#374151" opacity={0.5} />
                            <XAxis
                                dataKey="date"
                                stroke="#9CA3AF"
                                fontSize={12}
                                tickLine={false}
                                axisLine={false}
                            />
                            <YAxis
                                stroke="#9CA3AF"
                                fontSize={12}
                                tickLine={false}
                                axisLine={false}
                                tickFormatter={(value) => `${new Intl.NumberFormat('vi-VN').format(value)}`} // Định dạng số lượng
                            />
                            <Tooltip
                                contentStyle={{
                                    backgroundColor: "#18181b",
                                    border: "1px solid #3f3f46",
                                    borderRadius: "8px",
                                }}
                                itemStyle={{ color: "#fff" }}
                                // Thêm nhãn cho Tooltip
                                formatter={(value: number) => [new Intl.NumberFormat('vi-VN').format(value), "Sản phẩm"]} 
                            />
                            <Area
                                type="monotone"
                                dataKey="count"
                                stroke="#006FEE"
                                fillOpacity={1}
                                fill="url(#colorCount)"
                                name="Số Lượng Sản Phẩm" // Dịch tên đường dữ liệu
                            />
                        </AreaChart>
                    </ResponsiveContainer>
                </div>
            </CardBody>
        </Card>
    );
};

================
File: components/data-quality-table.tsx
================
"use client";

import { Table, TableHeader, TableColumn, TableBody, TableRow, TableCell } from "@heroui/table";
import { Chip } from "@heroui/chip";
import { CheckCircleIcon, AlertOctagonIcon } from "lucide-react";

interface CheckItem {
    scope: string;
    table: string;
    rule: string;
    description: string;
    failed_count: number;
    severity: string;
}

export const DataQualityTable = ({ checks }: { checks: CheckItem[] }) => {
    return (
        <Table aria-label="Bảng Chất Lượng Dữ Liệu (DQ)" removeWrapper className="font-sans">
            <TableHeader>
                <TableColumn>TRẠNG THÁI</TableColumn>
                <TableColumn>PHẠM VI (SCOPE)</TableColumn>
                <TableColumn>QUY TẮC</TableColumn>
                <TableColumn>MÔ TẢ</TableColumn>
                <TableColumn>BẢN GHI LỖI</TableColumn>
                <TableColumn>MỨC ĐỘ</TableColumn>
            </TableHeader>
            <TableBody emptyContent="Không có kiểm tra DQ nào được định nghĩa.">
                {checks.map((check, idx) => (
                    <TableRow key={idx}>
                        <TableCell>
                            {check.failed_count === 0 ? (
                                <CheckCircleIcon size={20} className="text-success" />
                            ) : (
                                <AlertOctagonIcon size={20} className="text-danger" />
                            )}
                        </TableCell>
                        <TableCell>{check.scope}</TableCell>
                        <TableCell className="font-bold">{check.rule}</TableCell>
                        <TableCell className="text-default-500 text-sm">{check.description}</TableCell>
                        <TableCell>
                            <span className={check.failed_count > 0 ? "font-bold text-danger" : "text-default-400"}>
                                {new Intl.NumberFormat('vi-VN').format(check.failed_count)}
                            </span>
                        </TableCell>
                        <TableCell>
                            <Chip
                                size="sm"
                                variant="flat"
                                color={
                                    check.severity === "CRITICAL" ? "danger" :
                                        check.severity === "HIGH" ? "warning" : "default"
                                }
                            >
                                {check.severity === "CRITICAL" ? "NGHIÊM TRỌNG" : 
                                 check.severity === "HIGH" ? "CAO" :
                                 check.severity === "MEDIUM" ? "TRUNG BÌNH" : "THẤP"}
                            </Chip>
                        </TableCell>
                    </TableRow>
                ))}
            </TableBody>
        </Table>
    );
};

================
File: components/dictionary-editor.tsx
================
"use client";

import { useState, useEffect } from "react";
import { Card, CardBody, CardHeader } from "@heroui/card";
import { Table, TableHeader, TableColumn, TableBody, TableRow, TableCell } from "@heroui/table";
import { Input } from "@heroui/input";
import { Button } from "@heroui/button";
import { ScrollShadow } from "@heroui/scroll-shadow";
import { SearchIcon, SaveIcon, Edit3Icon, TableIcon, DatabaseIcon, BookOpenIcon } from "lucide-react";
import { Accordion, AccordionItem } from "@heroui/accordion";
import { Chip } from "@heroui/chip";
import { saveColumnNote } from "@/app/actions/dictionary";

interface ColumnDef {
  name: string;
  type: string;
  description: string;
}

export default function DictionaryEditor({ initialData }: { initialData: any }) {
  const [selectedSchema, setSelectedSchema] = useState<string>("");
  const [selectedTable, setSelectedTable] = useState<string>("");
  const [columns, setColumns] = useState<ColumnDef[]>([]);
  
  // State quản lý việc Edit: { "colName": "nội dung đang gõ" }
  const [editingCell, setEditingCell] = useState<string | null>(null);
  const [tempDesc, setTempDesc] = useState("");
  const [isSaving, setIsSaving] = useState(false);

  // Chọn mặc định bảng đầu tiên khi load
  useEffect(() => {
    if (initialData) {
      const firstSchema = Object.keys(initialData)[0];
      if (firstSchema) {
        const firstTable = Object.keys(initialData[firstSchema])[0];
        handleSelectTable(firstSchema, firstTable);
      }
    }
  }, [initialData]);

  const handleSelectTable = (schema: string, table: string) => {
    setSelectedSchema(schema);
    setSelectedTable(table);
    setColumns(initialData[schema][table]);
    setEditingCell(null); // Reset edit mode
  };

  const startEdit = (colName: string, currentDesc: string) => {
    setEditingCell(colName);
    setTempDesc(currentDesc);
  };

  const saveEdit = async (colName: string) => {
    setIsSaving(true);
    const result = await saveColumnNote(selectedSchema, selectedTable, colName, tempDesc);
    
    if (result.success) {
      // Update UI state local để không cần reload trang
      const newCols = columns.map(c => c.name === colName ? { ...c, description: tempDesc } : c);
      setColumns(newCols);
      
      // Cập nhật lại cả initialData (để khi chuyển tab không bị mất)
      initialData[selectedSchema][selectedTable] = newCols;
      
      setEditingCell(null);
    } else {
      alert("Lưu ghi chú thất bại");
    }
    setIsSaving(false);
  };

  return (
    <div className="flex h-[calc(100vh-100px)] gap-4 font-sans">
      
      {/* SIDEBAR: Table List */}
      <Card className="w-80 flex-none h-full flex flex-col">
        <CardHeader className="pb-0 pt-4 px-4 flex-col items-start">
            <h4 className="font-bold text-large flex items-center gap-2">
                <BookOpenIcon size={20}/> Từ Điển Dữ Liệu
            </h4>
            <p className="text-tiny text-default-500">Chọn một bảng để tài liệu hóa</p>
        </CardHeader>
        <CardBody className="p-2">
            <ScrollShadow className="h-full">
                <Accordion selectionMode="multiple" isCompact itemClasses={{ title: "font-bold text-sm text-primary" }}>
                    {Object.keys(initialData).map((schema) => (
                        <AccordionItem key={schema} title={schema} startContent={<DatabaseIcon size={14}/>}>
                            <div className="flex flex-col gap-1 pl-2">
                                {Object.keys(initialData[schema]).map(table => (
                                    <Button
                                        key={table}
                                        variant={selectedTable === table && selectedSchema === schema ? "flat" : "light"}
                                        color="primary"
                                        className="justify-start h-8 text-sm"
                                        startContent={<TableIcon size={14} className="opacity-50"/>}
                                        onPress={() => handleSelectTable(schema, table)}
                                    >
                                        {table}
                                    </Button>
                                ))}
                            </div>
                        </AccordionItem>
                    ))}
                </Accordion>
            </ScrollShadow>
        </CardBody>
      </Card>

      {/* MAIN: Column Editor */}
      <div className="flex-1 flex flex-col gap-4 min-w-0">
         <Card className="flex-1 h-full">
            <CardHeader className="flex justify-between items-center bg-default-50 border-b border-default-100 py-3">
                <div className="flex flex-col">
                    <h2 className="text-xl font-bold flex items-center gap-2">
                        {selectedTable}
                        <Chip size="sm" variant="flat" color="secondary">{selectedSchema}</Chip>
                    </h2>
                    <p className="text-small text-default-500">
                        {columns.length} cột có sẵn
                    </p>
                </div>
            </CardHeader>
            <CardBody className="p-0 overflow-hidden">
                <Table 
                    aria-label="Bảng Từ Điển" 
                    removeWrapper 
                    isHeaderSticky
                    classNames={{ base: "h-full overflow-auto", table: "min-h-[300px]" }}
                >
                    <TableHeader>
                        <TableColumn width={200}>TÊN CỘT</TableColumn>
                        <TableColumn width={150}>KIỂU DỮ LIỆU</TableColumn>
                        <TableColumn>MÔ TẢ NGHIỆP VỤ (Nhấn để Chỉnh sửa)</TableColumn>
                    </TableHeader>
                    <TableBody items={columns}>
                        {(item) => (
                            <TableRow key={item.name}>
                                <TableCell className="font-bold font-mono">{item.name}</TableCell>
                                <TableCell className="text-default-500 text-xs font-mono">{item.type}</TableCell>
                                <TableCell>
                                    {editingCell === item.name ? (
                                        <div className="flex gap-2 items-center">
                                            <Input
                                                autoFocus
                                                size="sm"
                                                value={tempDesc}
                                                onChange={(e) => setTempDesc(e.target.value)}
                                                onKeyDown={(e) => {
                                                    if (e.key === 'Enter') saveEdit(item.name);
                                                    if (e.key === 'Escape') setEditingCell(null);
                                                }}
                                                placeholder="Nhập ý nghĩa nghiệp vụ..."
                                                className="w-full"
                                            />
                                            <Button isIconOnly size="sm" color="success" variant="flat" onPress={() => saveEdit(item.name)} isLoading={isSaving}>
                                                <SaveIcon size={16}/>
                                            </Button>
                                        </div>
                                    ) : (
                                        <div 
                                            className="group flex justify-between items-center p-2 -ml-2 rounded-lg hover:bg-default-100 cursor-pointer transition-colors border border-transparent hover:border-default-200 min-h-[40px]"
                                            onClick={() => startEdit(item.name, item.description)}
                                        >
                                            <span className={item.description ? "text-default-700" : "text-default-300 italic"}>
                                                {item.description || "Chưa có mô tả."}
                                            </span>
                                            <Edit3Icon size={14} className="opacity-0 group-hover:opacity-50 text-primary" />
                                        </div>
                                    )}
                                </TableCell>
                            </TableRow>
                        )}
                    </TableBody>
                </Table>
            </CardBody>
         </Card>
      </div>
    </div>
  );
}

================
File: components/download-btn.tsx
================
"use client";

import { Button } from "@heroui/button";
import { DownloadIcon } from "lucide-react";
import * as XLSX from "xlsx";

interface DownloadBtnProps {
    data: any[];
    fileName?: string;
    label?: string;
    color?: "primary" | "secondary" | "success" | "warning" | "danger" | "default";
}

export const DownloadBtn = ({
    data,
    fileName = "export-data",
    label = "Xuất Excel", // Dịch: Export Excel
    color = "primary",
}: DownloadBtnProps) => {
    const handleExport = () => {
        if (!data || data.length === 0) {
            // Thay thế alert() bằng console.error theo hướng dẫn
            console.error("Không có dữ liệu để xuất"); 
            return;
        }

        // 1. Tạo Worksheet từ JSON
        const worksheet = XLSX.utils.json_to_sheet(data);

        // 2. Tạo Workbook và thêm Worksheet vào
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");

        // 3. Xuất file
        XLSX.writeFile(workbook, `${fileName}.xlsx`);
    };

    return (
        <Button
            color={color}
            variant="flat"
            startContent={<DownloadIcon size={18} />}
            onPress={handleExport}
            size="sm"
            className="font-sans"
        >
            {label}
        </Button>
    );
};

================
File: components/edit-source-modal.tsx
================
"use client";

import {Modal, ModalBody, ModalContent, ModalFooter, ModalHeader, useDisclosure} from '@heroui/modal'
import {Input} from '@heroui/input'
import {Checkbox} from '@heroui/checkbox'
import { EditIcon } from "lucide-react";
import { updateSource } from "@/app/actions/sources";
import { useState } from "react";
import { Tooltip } from '@heroui/tooltip';
import { Button } from '@heroui/button';

// Định nghĩa kiểu dữ liệu cho props
interface SourceConfig {
  id: number;
  source_name: string;
  base_url: string;
  is_active: boolean;
}

export const EditSourceModal = ({ source }: { source: SourceConfig }) => {
  const { isOpen, onOpen, onOpenChange, onClose } = useDisclosure();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState("");

  const handleSubmit = async (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    setIsLoading(true);
    setError("");

    const formData = new FormData(event.currentTarget);
    const result = await updateSource(source.id, formData);

    setIsLoading(false);

    if (result.error) {
      setError(result.error);
    } else {
      onClose();
    }
  };

  return (
    <>
      <Tooltip content="Chỉnh sửa nguồn">
        <span 
          className="text-lg text-default-400 cursor-pointer active:opacity-50 hover:text-primary font-sans"
          onClick={onOpen}
        >
          <EditIcon size={18} />
        </span>
      </Tooltip>

      <Modal isOpen={isOpen} onOpenChange={onOpenChange} placement="top-center">
        <ModalContent className="font-sans">
          {(onClose) => (
            <form onSubmit={handleSubmit}>
              <ModalHeader className="flex flex-col gap-1">Chỉnh Sửa Nguồn #{source.id}</ModalHeader>
              <ModalBody>
                {error && <div className="text-danger text-sm">{error}</div>}
                
                <Input
                  label="Tên Nguồn"
                  name="source_name"
                  defaultValue={source.source_name}
                  variant="bordered"
                  isRequired
                />
                <Input
                  label="URL Gốc (Base URL)"
                  name="base_url"
                  defaultValue={source.base_url} 
                  variant="bordered"
                  isRequired
                />
                <div className="flex py-2 px-1 justify-between">
                  <Checkbox 
                    name="is_active" 
                    defaultSelected={source.is_active}
                    value="true"
                  >
                    Đang Hoạt Động
                  </Checkbox>
                </div>
              </ModalBody>
              <ModalFooter>
                <Button color="danger" variant="flat" onPress={onClose}>
                  Hủy Bỏ
                </Button>
                <Button color="primary" type="submit" isLoading={isLoading}>
                  Cập Nhật Cấu Hình
                </Button>
              </ModalFooter>
            </form>
          )}
        </ModalContent>
      </Modal>
    </>
  );
};

================
File: components/negative-reviews-table.tsx
================
"use client";

import { Table, TableHeader, TableColumn, TableBody, TableRow, TableCell } from "@heroui/table";
import { User } from "@heroui/user";
import { Chip } from "@heroui/chip";
import { StarIcon } from "lucide-react";

export const NegativeReviewsTable = ({ reviews }: { reviews: any[] }) => {
  return (
    <Table aria-label="Đánh giá tiêu cực" removeWrapper className="font-sans">
      <TableHeader>
        <TableColumn>SẢN PHẨM</TableColumn>
        <TableColumn>ĐIỂM SỐ</TableColumn>
        <TableColumn>BÌNH LUẬN</TableColumn>
        <TableColumn>NGÀY ĐÁNH GIÁ</TableColumn>
      </TableHeader>
      <TableBody emptyContent="Không tìm thấy đánh giá tiêu cực nào">
        {reviews.map((review, idx) => (
          <TableRow key={idx}>
            <TableCell>
              <div className="flex flex-col">
                <span className="text-small font-bold truncate w-[200px]" title={review.dim_sku?.dim_product?.title}>
                    {review.dim_sku?.dim_product?.title || "Sản phẩm không rõ"}
                </span>
                <span className="text-tiny text-default-400">{review.dim_shop?.shop_name}</span>
              </div>
            </TableCell>
            <TableCell>
                <div className="flex gap-0.5">
                    {[...Array(5)].map((_, i) => (
                        <StarIcon 
                            key={i} 
                            size={12} 
                            className={i < review.rating ? "text-danger fill-danger" : "text-default-200"} 
                        />
                    ))}
                </div>
            </TableCell>
            <TableCell>
                <div className="max-w-[300px] text-small italic text-default-500 truncate">
                    "{review.review_id}" (Nội dung giữ chỗ)
                </div>
            </TableCell>
            <TableCell>
                {review.review_timestamp ? new Date(review.review_timestamp).toLocaleDateString('vi-VN') : 'N/A'}
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  );
};

================
File: components/product-history-chart.tsx
================
"use client";

import {
    LineChart,
    Line,
    XAxis,
    YAxis,
    CartesianGrid,
    Tooltip,
    Legend,
    ResponsiveContainer,
} from "recharts";
import { Card, CardBody, CardHeader } from "@heroui/card";

export const ProductHistoryChart = ({ data }: { data: any[] }) => {
    return (
        <Card className="min-h-[400px] font-sans">
            <CardHeader>
                <h3 className="font-semibold text-lg">Lịch Sử Giá và Tồn Kho</h3>
            </CardHeader>
            <CardBody>
                <div className="w-full h-[350px]">
                    <ResponsiveContainer width="100%" height="100%">
                        <LineChart
                            data={data}
                            margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                        >
                            <CartesianGrid strokeDasharray="3 3" opacity={0.3} />
                            <XAxis dataKey="date" fontSize={12} stroke="#888888" />

                            {/* Trục Y trái: Giá tiền */}
                            <YAxis
                                yAxisId="left"
                                fontSize={12}
                                tickFormatter={(val) => `${val / 1000}k`}
                                stroke="#006FEE"
                            />

                            {/* Trục Y phải: Tồn kho */}
                            <YAxis
                                yAxisId="right"
                                orientation="right"
                                fontSize={12}
                                stroke="#17C964"
                            />

                            <Tooltip
                                contentStyle={{ backgroundColor: "#1f1f1f", border: "none", borderRadius: "8px" }}
                                labelStyle={{ color: "#aaa" }}
                            />
                            <Legend />

                            <Line
                                yAxisId="left"
                                type="monotone"
                                dataKey="price"
                                stroke="#006FEE"
                                name="Giá Bán (VND)" // Dịch tên đường dữ liệu
                                strokeWidth={2}
                                dot={false}
                            />
                            <Line
                                yAxisId="right"
                                type="monotone"
                                dataKey="stock"
                                stroke="#17C964"
                                name="Tồn Kho (SL)" // Dịch tên đường dữ liệu
                                strokeWidth={2}
                                dot={false}
                            />
                        </LineChart>
                    </ResponsiveContainer>
                </div>
            </CardBody>
        </Card>
    );
};

================
File: components/rating-pie-chart.tsx
================
"use client";

import { PieChart, Pie, Cell, Tooltip, ResponsiveContainer, Legend } from "recharts";
import { Card, CardBody, CardHeader } from "@heroui/card";

const COLORS = ["#F31260", "#F5A524", "#eab308", "#17C964", "#006FEE"]; // Đỏ -> Cam -> Vàng -> Xanh lá -> Xanh dương

export const RatingPieChart = ({ data }: { data: any[] }) => {
  return (
    <Card className="h-full min-h-[350px] font-sans">
      <CardHeader>
        <h3 className="font-semibold text-lg">Phân Bố Điểm Đánh Giá (Rating)</h3>
      </CardHeader>
      <CardBody>
        <ResponsiveContainer width="100%" height={300}>
          <PieChart>
            <Pie
              data={data}
              cx="50%"
              cy="50%"
              innerRadius={60}
              outerRadius={80}
              paddingAngle={5}
              dataKey="count"
              nameKey="rating"
            >
              {data.map((entry, index) => (
                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
              ))}
            </Pie>
            <Tooltip 
                formatter={(value: number) => new Intl.NumberFormat('vi-VN').format(value) + " đánh giá"} // Dịch chuỗi hiển thị số lượng
                contentStyle={{ backgroundColor: "#1f1f1f", border: "none", borderRadius: "8px" }}
            />
            <Legend verticalAlign="bottom" height={36}/>
          </PieChart>
        </ResponsiveContainer>
      </CardBody>
    </Card>
  );
};

================
File: components/raw-data-table.tsx
================
"use client";

import { useState } from "react";
import { useRouter, usePathname, useSearchParams } from "next/navigation";
import { Table, TableBody, TableCell, TableColumn, TableHeader, TableRow } from "@heroui/table";
import { Pagination } from "@heroui/pagination";
import { Modal, ModalContent, ModalHeader, ModalBody, ModalFooter, useDisclosure } from "@heroui/modal";
import { Button } from "@heroui/button";
import { EyeIcon } from "lucide-react";
import dynamic from "next/dynamic";

// Import động để tránh lỗi SSR (Server Side Rendering) vì thư viện này cần window
const ReactJson = dynamic(() => import("react-json-view"), { ssr: false });

interface RawProduct {
    id: string;
    product_id: string;
    source_file_name: string | null;
    load_timestamp: string;
    raw_data: any;
}

export const RawDataTable = ({
    data,
    totalPages
}: {
    data: RawProduct[];
    totalPages: number
}) => {
    const router = useRouter();
    const pathname = usePathname();
    const searchParams = useSearchParams();
    const { isOpen, onOpen, onOpenChange } = useDisclosure();
    const [selectedJson, setSelectedJson] = useState<any>(null);

    const currentPage = Number(searchParams.get("page")) || 1;

    const handlePageChange = (page: number) => {
        const params = new URLSearchParams(searchParams);
        params.set("page", page.toString());
        router.push(`${pathname}?${params.toString()}`);
    };

    const handleViewJson = (json: any) => {
        setSelectedJson(json);
        onOpen();
    };

    return (
        <>
            <Table
                aria-label="Bảng dữ liệu sản phẩm thô"
                className="font-sans"
                bottomContent={
                    totalPages > 1 && (
                        <div className="flex w-full justify-center">
                            <Pagination
                                isCompact
                                showControls
                                showShadow
                                color="primary"
                                page={currentPage}
                                total={totalPages}
                                onChange={handlePageChange}
                            />
                        </div>
                    )
                }
            >
                <TableHeader>
                    <TableColumn>ID</TableColumn>
                    <TableColumn>ID SẢN PHẨM</TableColumn>
                    <TableColumn>FILE NGUỒN</TableColumn>
                    <TableColumn>THỜI GIAN NẠP</TableColumn>
                    <TableColumn>HÀNH ĐỘNG</TableColumn>
                </TableHeader>
                <TableBody emptyContent="Không tìm thấy dữ liệu thô nào">
                    {data.map((item) => (
                        <TableRow key={item.id}>
                            <TableCell>#{item.id}</TableCell>
                            <TableCell className="font-semibold">{item.product_id}</TableCell>
                            <TableCell>{item.source_file_name || "N/A"}</TableCell>
                            <TableCell>{item.load_timestamp ? new Date(item.load_timestamp).toLocaleString('vi-VN') : ''}</TableCell>
                            <TableCell>
                                <Button
                                    size="sm"
                                    variant="flat"
                                    color="primary"
                                    isIconOnly
                                    onPress={() => handleViewJson(item.raw_data)}
                                    title="Xem JSON thô"
                                >
                                    <EyeIcon size={18} />
                                </Button>
                            </TableCell>
                        </TableRow>
                    ))}
                </TableBody>
            </Table>

            {/* JSON Viewer Modal */}
            <Modal
                isOpen={isOpen}
                onOpenChange={onOpenChange}
                size="5xl" // Tăng size modal để xem cho thoải mái
                scrollBehavior="inside"
            >
                <ModalContent className="font-sans">
                    {(onClose) => (
                        <>
                            <ModalHeader className="flex flex-col gap-1">Trình Kiểm Tra JSON Thô</ModalHeader>
                            <ModalBody className="p-0">
                                {/* p-0 để viewer full viền */}
                                <div className="min-h-[400px] max-h-[70vh] overflow-auto bg-[#1e1e1e]">
                                    {selectedJson && (
                                        <ReactJson
                                            src={
                                                typeof selectedJson === 'string'
                                                    ? JSON.parse(selectedJson)
                                                    : (selectedJson || {})
                                            }
                                            theme="monokai"
                                            collapsed={1}
                                            displayDataTypes={false}
                                            enableClipboard={true}
                                            style={{ padding: '20px', backgroundColor: 'transparent' }}
                                        />
                                    )}
                                </div>
                            </ModalBody>
                            <ModalFooter>
                                <Button color="danger" variant="light" onPress={onClose}>
                                    Đóng
                                </Button>
                            </ModalFooter>
                        </>
                    )}
                </ModalContent>
            </Modal>
        </>
    );
};

================
File: components/recent-logs-table.tsx
================
"use client"; 

import { Table, TableHeader, TableColumn, TableBody, TableRow, TableCell } from "@heroui/table";
import { Chip } from "@heroui/chip";

export const RecentLogsTable = ({ logs }: { logs: any[] }) => {
    return (
        <Table aria-label="Logs gần đây" removeWrapper className="font-sans">
            <TableHeader>
                <TableColumn>TÊN NGUỒN</TableColumn>
                <TableColumn>ID NGUỒN</TableColumn>
                <TableColumn>TRẠNG THÁI</TableColumn>
            </TableHeader>
            <TableBody emptyContent="Không có hoạt động gần đây">
                {logs.map((log) => (
                    <TableRow key={log.id}>
                        <TableCell>
                            <div className="flex flex-col">
                                <span className="text-small font-bold">
                                    {log.source_config?.source_name || "Nguồn không rõ"}
                                </span>
                                <span className="text-tiny text-default-400">
                                    {log.created_at
                                        ? new Date(log.created_at).toLocaleTimeString("vi-VN")
                                        : ""}
                                </span>
                            </div>
                        </TableCell>
                        <TableCell>
                            <div className="flex flex-col">
                                <span className="text-small font-bold">
                                    #{log.source_config?.id || "Nguồn không rõ"}
                                </span>
                            </div>
                        </TableCell>
                        <TableCell>
                            <Chip
                                size="sm"
                                variant="dot"
                                color={
                                    log.status === "SUCCESS"
                                        ? "success"
                                        : log.status === "FAILED"
                                            ? "danger"
                                            : "warning"
                                }
                            >
                                {log.status === "SUCCESS" ? "THÀNH CÔNG" : log.status === "FAILED" ? "THẤT BẠI" : "ĐANG CHẠY"}
                            </Chip>
                        </TableCell>
                    </TableRow>
                ))}
            </TableBody>
        </Table>
    );
};

================
File: components/settings-editor.tsx
================
"use client";

import { useState } from "react";
import { Tabs, Tab } from "@heroui/tabs";
import { Card, CardBody } from "@heroui/card";
import { Input } from "@heroui/input";
import { Switch } from "@heroui/switch";
import { Button } from "@heroui/button";
import { SaveIcon, RefreshCwIcon, SettingsIcon } from "lucide-react";
import { updateSetting } from "@/app/actions/settings";
import { Chip } from "@heroui/chip";

interface SettingItem {
  key: string;
  value: string;
  type: string;
  group: string;
  description: string | null;
}

export default function SettingsEditor({ settings }: { settings: SettingItem[] }) {
  // Group settings by 'group' field
  const groupedSettings = settings.reduce((acc, curr) => {
    if (!acc[curr.group]) acc[curr.group] = [];
    acc[curr.group].push(curr);
    return acc;
  }, {} as Record<string, SettingItem[]>);

  const [loadingKeys, setLoadingKeys] = useState<Record<string, boolean>>({});

  const handleSave = async (key: string, newValue: string) => {
    setLoadingKeys(prev => ({ ...prev, [key]: true }));
    
    const res = await updateSetting(key, newValue);
    
    if (res.error) {
        // Thay thế alert() bằng console.error
        console.error("Lưu thất bại:", res.error);
    }
    
    setLoadingKeys(prev => ({ ...prev, [key]: false }));
  };

  return (
    <div className="flex flex-col gap-6 font-sans">
      <Tabs aria-label="Nhóm Cấu Hình" color="primary" variant="underlined">
        {Object.keys(groupedSettings).map((group) => (
          <Tab key={group} title={group}>
            <Card>
              <CardBody className="gap-6 p-6">
                {groupedSettings[group].map((setting) => (
                  <div key={setting.key} className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between border-b border-default-100 pb-6 last:border-0 last:pb-0">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                          <p className="font-bold text-sm">{setting.key}</p>
                          <Chip size="sm" variant="flat" className="text-[10px] h-5">{setting.type}</Chip>
                      </div>
                      <p className="text-small text-default-500">{setting.description || "Không có mô tả."}</p>
                    </div>

                    <div className="w-full sm:w-64 flex items-center gap-2">
                      {setting.type === 'boolean' ? (
                        <Switch 
                          defaultSelected={setting.value === 'true'}
                          onValueChange={(val) => handleSave(setting.key, String(val))}
                          isDisabled={loadingKeys[setting.key]}
                        >
                            {/* Dịch nhãn Switch */}
                            {setting.value === 'true' ? "Đã Bật" : "Đã Tắt"}
                        </Switch>
                      ) : (
                        <div className="flex w-full gap-2">
                            <Input 
                                defaultValue={setting.value}
                                type={setting.type === 'number' ? 'number' : 'text'}
                                size="sm"
                                variant="bordered"
                                onKeyDown={(e) => {
                                    if(e.key === 'Enter') handleSave(setting.key, e.currentTarget.value)
                                }}
                                onBlur={(e) => {
                                    // Optional: Auto save on blur or specific logic
                                }}
                                // Placeholder phù hợp
                                placeholder={setting.type === 'number' ? 'Nhập số' : 'Nhập giá trị'}
                            />
                            <Button 
                                isIconOnly 
                                size="sm" 
                                color="primary" 
                                variant="flat"
                                isLoading={loadingKeys[setting.key]}
                                onPress={(e) => {
                                   const input = e.target.closest('div')?.querySelector('input');
                                   if(input) handleSave(setting.key, input.value);
                                }}
                                title="Lưu"
                            >
                                <SaveIcon size={16}/>
                            </Button>
                        </div>
                      )}
                    </div>
                  </div>
                ))}
              </CardBody>
            </Card>
          </Tab>
        ))}
      </Tabs>
    </div>
  );
}

================
File: components/shops-table.tsx
================
"use client";

import { Table, TableHeader, TableColumn, TableBody, TableRow, TableCell } from "@heroui/table";
import { User } from "@heroui/user";
import { Chip } from "@heroui/chip";
import { Pagination } from "@heroui/pagination";
import { useRouter, usePathname, useSearchParams } from "next/navigation";
import { StarIcon, MapPinIcon } from "lucide-react";

export const ShopsTable = ({ shops, totalPages }: { shops: any[], totalPages: number }) => {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();
  const currentPage = Number(searchParams.get("page")) || 1;

  const handlePageChange = (page: number) => {
    const params = new URLSearchParams(searchParams);
    params.set("page", page.toString());
    router.push(`${pathname}?${params.toString()}`);
  };

  // Helper format số lượng (vd: 1.2k)
  const formatCompactNumber = (number: number) => {
    return new Intl.NumberFormat('en-US', { notation: "compact", compactDisplay: "short" }).format(number);
  };

  return (
    <Table 
      aria-label="Bảng danh mục cửa hàng"
      className="font-sans"
      bottomContent={
        totalPages > 1 && (
          <div className="flex w-full justify-center">
             <Pagination showControls page={currentPage} total={totalPages} onChange={handlePageChange} />
          </div>
        )
      }
    >
      <TableHeader>
        <TableColumn>THÔNG TIN CỬA HÀNG</TableColumn>
        <TableColumn>ĐIỂM ĐÁNH GIÁ</TableColumn>
        <TableColumn>NGƯỜI THEO DÕI</TableColumn>
        <TableColumn>SẢN PHẨM ĐANG BÁN</TableColumn>
        <TableColumn>KHU VỰC</TableColumn>
      </TableHeader>
      <TableBody emptyContent="Không tìm thấy cửa hàng nào">
        {shops.map((shop) => {
            // Xử lý ảnh Logo từ JSON
            const logoData = shop.shop_logo ? (typeof shop.shop_logo === 'string' ? JSON.parse(shop.shop_logo) : shop.shop_logo) : [];
            // Giả sử logo là array string hoặc string url, lấy phần tử đầu
            const logoUrl = Array.isArray(logoData) ? logoData[0] : (typeof logoData === 'string' ? logoData : null);

            return (
            <TableRow key={shop.id}>
              <TableCell>
                <User
                  avatarProps={{ src: logoUrl, fallback: "CH" }}
                  description={shop.seller_id}
                  name={shop.shop_name || "Cửa hàng không rõ"}
                />
              </TableCell>
              <TableCell>
                <div className="flex items-center gap-1">
                    <StarIcon size={16} className="text-warning fill-warning" />
                    <span className="font-bold">{shop.shop_rating?.toFixed(1) || "N/A"}</span>
                </div>
              </TableCell>
              <TableCell>
                <Chip size="sm" variant="flat" color="primary">
                    {formatCompactNumber(Number(shop.followers_count || 0))}
                </Chip>
              </TableCell>
              <TableCell>{new Intl.NumberFormat('vi-VN').format(shop.on_sell_product_count || 0)}</TableCell>
              <TableCell>
                <div className="flex items-center gap-1 text-default-500">
                    <MapPinIcon size={14} />
                    <span className="text-small">{shop.region || "N/A"}</span>
                </div>
              </TableCell>
            </TableRow>
          );
        })}
      </TableBody>
    </Table>
  );
};

================
File: components/slow-queries-table.tsx
================
"use client";

import { Table, TableHeader, TableColumn, TableBody, TableRow, TableCell } from "@heroui/table";
import { AlertTriangleIcon, ZapIcon } from "lucide-react";

interface IndexUsageItem {
  table_name: string;
  full_scans: number;
  index_scans: number;
}

export const SlowQueriesTable = ({ data }: { data: IndexUsageItem[] }) => {
  if (data.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center h-full text-success gap-2 py-8 font-sans">
        <ZapIcon size={48} />
        <p>Tuyệt vời! Không phát hiện thấy các truy vấn quét toàn bộ bảng thường xuyên.</p>
      </div>
    );
  }

  return (
    <Table aria-label="Truy Vấn Chậm" removeWrapper className="font-sans">
      <TableHeader>
        <TableColumn>BẢNG DỮ LIỆU</TableColumn>
        <TableColumn>FULL SCANS (QUÉT TOÀN BỘ)</TableColumn>
        <TableColumn>INDEX SCANS (QUÉT CHỈ MỤC)</TableColumn>
      </TableHeader>
      <TableBody emptyContent="Không có dữ liệu truy vấn chậm">
        {data.map((item, idx) => (
          <TableRow key={idx}>
            <TableCell className="font-mono text-sm">{item.table_name}</TableCell>
            <TableCell>
              <div className="flex items-center gap-1 text-danger">
                <AlertTriangleIcon size={14} />
                {item.full_scans}
              </div>
            </TableCell>
            <TableCell>{item.index_scans}</TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  );
};

================
File: components/text-diff-viewer.tsx
================
"use client";

import { diffWords } from "diff";
import React from "react";

interface TextDiffProps {
    oldText?: string | null;
    newText?: string | null;
    label: string;
}

export const TextDiffViewer = ({ oldText, newText, label }: TextDiffProps) => {
    // Xử lý null/undefined
    const safeOld = oldText || "";
    const safeNew = newText || "";

    // Nếu không có thay đổi
    if (safeOld === safeNew) {
        return (
            <div className="mb-4 font-sans">
                <h4 className="text-sm font-semibold text-default-500 mb-1">{label}</h4>
                <div className="p-3 bg-default-50 rounded-lg text-sm text-default-600 border border-default-200">
                    {safeNew || <span className="italic text-default-400">Trống</span>}
                </div>
            </div>
        );
    }

    // Tính toán sự khác biệt (theo từ)
    const diff = diffWords(safeOld, safeNew);

    return (
        <div className="mb-4 font-sans">
            <div className="flex justify-between items-center mb-1">
                <h4 className="text-sm font-semibold text-default-500">{label}</h4>
                <span className="text-xs px-2 py-0.5 rounded bg-warning-100 text-warning-700">Đã Thay Đổi</span>
            </div>
            <div className="p-3 bg-default-50 rounded-lg text-sm leading-relaxed border border-default-200">
                {diff.map((part, index) => {
                    if (part.added) {
                        return (
                            <span key={index} className="bg-success-100 text-success-700 font-semibold px-0.5 rounded mx-0.5">
                                {part.value}
                            </span>
                        );
                    }
                    if (part.removed) {
                        return (
                            <span key={index} className="bg-danger-100 text-danger-700 line-through decoration-danger-700 px-0.5 rounded mx-0.5 opacity-80">
                                {part.value}
                            </span>
                        );
                    }
                    return <span key={index} className="text-default-700">{part.value}</span>;
                })}
            </div>
        </div>
    );
};

================
File: components/version-diff-modal.tsx
================
"use client";

import { Modal, ModalContent, ModalHeader, ModalBody, ModalFooter } from "@heroui/modal";
import { Button } from "@heroui/button";
import { ScrollShadow } from "@heroui/scroll-shadow";
import { TextDiffViewer } from "./text-diff-viewer";
import { GitCompareIcon, ArrowRightIcon } from "lucide-react";

interface VersionDiffModalProps {
  isOpen: boolean;
  onClose: () => void;
  currentVersion: any; // Bản ghi đang chọn
  previousVersion: any; // Bản ghi cũ hơn liền kề
}

export const VersionDiffModal = ({ isOpen, onClose, currentVersion, previousVersion }: VersionDiffModalProps) => {
  if (!currentVersion) return null;

  return (
    <Modal isOpen={isOpen} onClose={onClose} size="3xl" scrollBehavior="inside">
      <ModalContent className="font-sans">
        <ModalHeader className="flex flex-col gap-1">
          <div className="flex items-center gap-2">
            <GitCompareIcon size={20} className="text-primary"/>
            <span>So Sánh Phiên Bản Dimension</span>
          </div>
          <div className="flex items-center gap-2 text-tiny font-normal text-default-500 mt-1">
            <span>{previousVersion ? new Date(previousVersion.valid_from).toLocaleDateString('vi-VN') : 'Gốc'}</span>
            <ArrowRightIcon size={14} />
            <span className="font-bold text-foreground">
              {new Date(currentVersion.valid_from).toLocaleDateString('vi-VN')}
            </span>
          </div>
        </ModalHeader>
        
        <ModalBody>
          <ScrollShadow className="h-[60vh] pr-2">
            {!previousVersion ? (
               <div className="p-4 bg-primary-50 text-primary rounded-lg text-center">
                 Đây là phiên bản ghi nhận đầu tiên (Gốc). Không có phiên bản cũ hơn để so sánh.
               </div>
            ) : (
              <div className="space-y-2">
                {/* So sánh Tiêu đề */}
                <TextDiffViewer 
                  label="Tiêu Đề Sản Phẩm" 
                  oldText={previousVersion.title} 
                  newText={currentVersion.title} 
                />

                {/* So sánh Mô tả */}
                <TextDiffViewer 
                  label="Mô Tả" 
                  oldText={previousVersion.description} 
                  newText={currentVersion.description} 
                />

                 {/* So sánh Danh mục (Nếu categories là JSON string hoặc object, cần convert sang string) */}
                 <TextDiffViewer 
                  label="Danh Mục (Categories)" 
                  oldText={JSON.stringify(previousVersion.categories)} 
                  newText={JSON.stringify(currentVersion.categories)} 
                />
              </div>
            )}
          </ScrollShadow>
        </ModalBody>
        
        <ModalFooter>
          <Button color="primary" onPress={onClose}>
            Đóng
          </Button>
        </ModalFooter>
      </ModalContent>
    </Modal>
  );
};

================
File: config/fonts.ts
================
import { Inter, JetBrains_Mono } from "next/font/google";

export const fontSans = Inter({
  subsets: ["latin", "vietnamese"], 
  weight: ["300", "400", "500", "600", "700"], 
  variable: "--font-sans",
  display: "swap",
  adjustFontFallback: false
});

export const fontMono = JetBrains_Mono({
  subsets: ["latin", "vietnamese"],
  variable: "--font-mono",
  display: "swap",
});

================
File: types/schema.ts
================
export interface SourceConfig {
  id: number;
  source_name: string;
  base_url: string;
  is_active: boolean;
  last_crawl_status: "SUCCESS" | "FAILED" | "PENDING" | null;
  last_crawl_timestamp: string | null;
}

export interface CrawlLog {
  id: number;
  source_config_id: number;
  file_name: string;
  file_path: string;
  record_count: number;
  status: "PENDING" | "PROCESSING" | "SUCCESS" | "FAILED";
  error_message?: string;
  created_at: string;
}

export interface BaseProduct {
  id: string;
  product_id: string;
  title: string;
  price_sale: number;
  sold_count: number;
  seller_id: string;
  load_timestamp: string;
}

================
File: tailwind.config.js
================
import {heroui} from "@heroui/theme"

/** @type {import('tailwindcss').Config} */
const config = {
  content: [
    './components/**/*.{js,ts,jsx,tsx,mdx}',
    './app/**/*.{js,ts,jsx,tsx,mdx}',
    "./node_modules/@heroui/theme/dist/**/*.{js,ts,jsx,tsx}"
  ],
  theme: {
    extend: {
      fontFamily: {
        sans: ["var(--font-sans)", "Segoe UI", "-apple-system", "sans-serif"],
        mono: ["var(--font-mono)", "Consolas", "monospace"],
      },
    },
  },
  darkMode: "class",
  plugins: [heroui()],
}

module.exports = config;

================
File: app/actions/sources.ts
================
"use server";

import { prisma } from "@/lib/prisma";
import { revalidatePath } from "next/cache";
import { getConfig } from "./settings";

export async function createSource(formData: FormData) {
  const source_name = formData.get("source_name") as string;
  const base_url = formData.get("base_url") as string;
  const is_active = formData.get("is_active") !== null; 

  if (!source_name || !base_url) {
    return { error: "Name and URL are required" };
  }

  try {
    await prisma.source_config.create({
      data: {
        source_name,
        base_url,
        is_active,
        last_crawl_status: "PENDING",
      },
    });

    revalidatePath("/sources");
    
    return { success: true };
  } catch (error) {
    console.error("Create source error:", error);
    return { error: "Failed to create source. URL might be duplicate." };
  }
}

export async function deleteSource(id: number) {
  try {
    await prisma.source_config.delete({
      where: { id },
    });
    revalidatePath("/sources");
    return { success: true };
  } catch (error) {
    return { error: "Failed to delete source" };
  }
}

export async function updateSource(id: number, formData: FormData) {
  const source_name = formData.get("source_name") as string;
  const base_url = formData.get("base_url") as string;
  const is_active = formData.get("is_active") !== null;

  if (!source_name || !base_url) {
    return { error: "Name and URL are required" };
  }

  try {
    await prisma.source_config.update({
      where: { id },
      data: {
        source_name,
        base_url,
        is_active,
      },
    });

    revalidatePath("/sources");
    return { success: true };
  } catch (error) {
    console.error("Update source error:", error);
    return { error: "Failed to update source." };
  }
}
export async function triggerCrawl(sourceId: number) {
  try {
    const source = await prisma.source_config.findUnique({
      where: { id: sourceId }
    });

    if (source?.last_crawl_status === "PENDING" || source?.last_crawl_status === "PROCESSING") {
      const stuckThreshold = await getConfig("JOB_STUCK_THRESHOLD_MINUTES", 60);
      
      const lastUpdate = new Date(source.updated_at || source.last_crawl_timestamp || new Date());
      const now = new Date();
      const diffMinutes = (now.getTime() - lastUpdate.getTime()) / 60000;

      if (diffMinutes < stuckThreshold) {
        return { error: `Job is currently running (started ${Math.round(diffMinutes)} mins ago). Please wait or adjust JOB_STUCK_THRESHOLD.` };
      }
      
      // Nếu > threshold, coi như job cũ bị chết, cho phép chạy đè job mới
      console.log(`Job ${sourceId} seems stuck (${diffMinutes} mins). Forcing new trigger.`);
    }

    await prisma.source_config.update({
      where: { id: sourceId },
      data: {
        last_crawl_status: "PENDING",
        updated_at: new Date(), 
      },
    });


    revalidatePath("/sources");
    return { success: true };
  } catch (error) {
    console.error("Trigger crawl error:", error);
    return { error: "Failed to trigger crawl." };
  }
}

================
File: app/analytics/page.tsx
================
import { Card, CardBody, CardHeader } from "@heroui/card";
import { prisma } from "@/lib/prisma";
import { serializeData } from "@/lib/utils";
import { TrendingUpIcon, StoreIcon, CalendarIcon, FilterXIcon } from "lucide-react";
import { TopProductsTable, TopShopsTable } from "@/components/analytics-tables";
import { DownloadBtn } from "@/components/download-btn";
import { DateRangeFilter } from "@/components/date-range-filter";

// Hàm lấy ngày mới nhất có dữ liệu trong khoảng filter
async function getTargetDateKey(from?: string, to?: string) {
  // Nếu không có filter, lấy ngày max tuyệt đối trong hệ thống
  if (!from || !to) {
    const maxResult = await prisma.fact_sales_snapshot.aggregate({
      _max: { date_key: true }
    });
    return maxResult._max.date_key;
  }

  // Nếu có filter, tìm date_key lớn nhất (gần nhất) nằm trong khoảng đó
  // Cần join với dim_date để so sánh ngày thực tế
  const targetDateInfo = await prisma.dim_date.findFirst({
    where: {
      full_date: {
        gte: new Date(from),
        lte: new Date(to)
      }
    },
    orderBy: { date_key: 'desc' }, // Lấy ngày cuối cùng của khoảng
    select: { date_key: true }
  });

  return targetDateInfo?.date_key || null;
}

async function getWarehouseData(from?: string, to?: string) {
  // 1. Xác định Date Key cần query
  const targetDateKey = await getTargetDateKey(from, to);

  if (!targetDateKey) {
    return { topProducts: [], topShops: [], displayDate: "Không tìm thấy dữ liệu", hasData: false };
  }

  // Lấy thông tin hiển thị ngày
  const dateInfo = await prisma.dim_date.findUnique({
    where: { date_key: targetDateKey }
  });
  const dateDisplay = dateInfo 
    ? new Date(dateInfo.full_date).toLocaleDateString('vi-VN') 
    : targetDateKey.toString();

  // 2. Top Products (Snapshot tại ngày target)
  const topProductsRaw: any[] = await prisma.$queryRaw`
    SELECT 
      p.title, p.product_id,
      MAX(s.shop_name) as shop_name,
      MAX(f.sold_count) as sold_count,
      MAX(f.price_sale) as price_sale
    FROM "warehouse"."fact_sales_snapshot" f
    JOIN "warehouse"."dim_product" p ON f.product_key = p.product_key
    JOIN "warehouse"."dim_shop" s ON f.shop_key = s.shop_key
    WHERE f.date_key = ${targetDateKey}
    GROUP BY p.product_key, p.title, p.product_id
    ORDER BY sold_count DESC
    LIMIT 50 -- Lấy 50 để export Excel cho sướng, Table hiển thị 5 cũng được
  `;

  // Format cho Table hiển thị
  const topProductsFormatted = topProductsRaw.map(item => ({
    dim_product: { title: item.title, product_id: item.product_id },
    dim_shop: { shop_name: item.shop_name },
    sold_count: item.sold_count,
    price_sale: item.price_sale
  }));

  // Format flat data cho Excel export
  const topProductsExport = topProductsRaw.map(item => ({
    "Tên Sản Phẩm": item.title,
    "ID Sản Phẩm": item.product_id,
    "Tên Cửa Hàng": item.shop_name,
    "Số Lượng Đã Bán": Number(item.sold_count), // BigInt safe convert
    "Giá Bán": Number(item.price_sale)
  }));

  // 3. Top Shops (Snapshot tại ngày target)
  const topShopsRaw: any[] = await prisma.$queryRaw`
    WITH unique_products AS (
      SELECT DISTINCT ON (f.product_key)
        f.product_key,
        f.shop_key,
        f.sold_count,
        f.price_sale
      FROM "warehouse"."fact_sales_snapshot" f
      WHERE f.date_key = ${targetDateKey}
      ORDER BY f.product_key, f.sold_count DESC
    )
    SELECT 
      s.shop_name, s.seller_id,
      SUM(u.sold_count * u.price_sale) as revenue,
      SUM(u.sold_count) as total_sold
    FROM unique_products u
    JOIN "warehouse"."dim_shop" s ON u.shop_key = s.shop_key
    GROUP BY s.shop_name, s.seller_id
    ORDER BY revenue DESC
    LIMIT 50
  `;

  const topShopsExport = topShopsRaw.map(item => ({
    "Tên Cửa Hàng": item.shop_name,
    "ID Người Bán": item.seller_id,
    "Tổng Số Lượng Đã Bán": Number(item.total_sold),
    "Doanh Thu Ước Tính": Number(item.revenue)
  }));

  return {
    topProducts: serializeData(topProductsFormatted.slice(0, 10)), // Chỉ lấy 10 hiển thị
    topProductsExport: serializeData(topProductsExport), // Full list export
    topShops: serializeData(topShopsRaw.slice(0, 10)),
    topShopsExport: serializeData(topShopsExport),
    displayDate: dateDisplay,
    hasData: true
  };
}

export default async function AnalyticsPage({
  searchParams,
}: {
  searchParams: Promise<{ from?: string; to?: string }>;
}) {
  const params = await searchParams;
  const data = await getWarehouseData(params.from, params.to);

  return (
    <div className="space-y-6">
      {/* Header & Toolbar */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <h1 className="text-2xl font-bold">Phân Tích Data Warehouse</h1>
          <p className="text-small text-default-500">
            Phân tích dữ liệu Snapshot (Hiển thị dữ liệu cho ngày: <strong>{data.displayDate}</strong>)
          </p>
        </div>
        
        <div className="flex flex-col sm:flex-row gap-3 items-end sm:items-center w-full md:w-auto">
          <DateRangeFilter />
          
          <div className="flex items-center gap-2 text-default-500 text-sm bg-default-100 px-3 py-2 rounded-lg border border-default-200 h-10">
              <CalendarIcon size={16} />
              <span className="whitespace-nowrap">Snapshot: <strong>{data.displayDate}</strong></span>
          </div>
        </div>
      </div>
      
      {!data.hasData ? (
        <div className="flex flex-col items-center justify-center h-[300px] border border-dashed border-default-300 rounded-xl bg-default-50">
            <FilterXIcon size={48} className="text-default-300 mb-4"/>
            <h3 className="text-lg font-semibold text-default-500">Không tìm thấy Dữ liệu Snapshot</h3>
            <p className="text-sm text-default-400">Hãy thử chọn một khoảng ngày khác.</p>
        </div>
      ) : (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          
          {/* Top Products Card */}
          <Card>
            <CardHeader className="flex justify-between items-start">
              <div className="flex gap-3">
                <TrendingUpIcon className="text-primary" />
                <div className="flex flex-col">
                  <p className="text-md font-bold">Sản Phẩm Bán Chạy Nhất</p>
                  <p className="text-small text-default-500">Tổng số lượng đã bán tích lũy</p>
                </div>
              </div>
              <DownloadBtn 
                data={data.topProductsExport} 
                fileName={`Top_Products_${data.displayDate.replace(/\//g, '-')}`}
              />
            </CardHeader>
            <CardBody>
              <TopProductsTable products={data.topProducts} />
            </CardBody>
          </Card>

          {/* Top Shops Card */}
          <Card>
            <CardHeader className="flex justify-between items-start">
              <div className="flex gap-3">
                <StoreIcon className="text-success" />
                <div className="flex flex-col">
                  <p className="text-md font-bold">Cửa Hàng Doanh Thu Cao Nhất</p>
                  <p className="text-small text-default-500">Doanh thu dựa trên số lượng đã bán</p>
                </div>
              </div>
              <DownloadBtn 
                data={data.topShopsExport} 
                fileName={`Top_Shops_${data.displayDate.replace(/\//g, '-')}`}
                color="success"
              />
            </CardHeader>
            <CardBody>
              <TopShopsTable shops={data.topShops} />
            </CardBody>
          </Card>

        </div>
      )}
    </div>
  );
}

================
File: app/data-quality/page.tsx
================
import { prisma } from "@/lib/prisma";
import { Card, CardBody, CardHeader } from "@heroui/card";
import { Progress } from "@heroui/progress";
import { CheckCircleIcon, XCircleIcon, ClockIcon, ActivityIcon } from "lucide-react";
import { DataQualityTable } from "@/components/data-quality-table";
import { getConfig } from "../actions/settings";

// Định nghĩa kiểu dữ liệu cho Check Result
interface DqCheckResult {
    scope: "Staging" | "Warehouse" | "System";
    table: string;
    rule: string;
    description: string;
    failed_count: number;
    severity: "LOW" | "MEDIUM" | "HIGH" | "CRITICAL";
}

async function runDataQualityChecks() {
    // Sử dụng Promise.all để chạy song song các truy vấn, giảm thời gian chờ
    const [
        missingTitles,
        invalidPrices,
        negativeStock,
        missingRatings,
        shopsNoRegion,
        priceAnomalyRaw,
        latestRawData,
        penaltyWeight,
        criticalWeight,
        staleHoursLimit
    ] = await Promise.all([
        // 1. Check Missing Titles
        prisma.tbl_base_products.count({ where: { title: null } }),

        // 2. Check Invalid Price (<= 0)
        prisma.tbl_base_products.count({ where: { price_sale: { lte: 0 } } }),

        // 3. Check Negative Stock
        prisma.fact_inventory_snapshot.count({ where: { stock: { lt: 0 } } }),

        // 4. Check Missing Ratings
        prisma.fact_reviews.count({ where: { rating: null } }),

        // 5. Check Shops missing region info
        prisma.tbl_base_shop_info.count({ where: { region: null } }),

        // 6. Check Logic: Sale Price > Original Price (Bất thường)
        prisma.$queryRaw<{ count: bigint }[]>`
      SELECT COUNT(*) as count 
      FROM "staging"."tbl_base_products" 
      WHERE price_original IS NOT NULL 
      AND price_sale > price_original
    `,

        // 7. Check Data Freshness (Lần cuối crawl)
        prisma.tbl_products_raw.findFirst({
            orderBy: { load_timestamp: 'desc' },
            select: { load_timestamp: true }
        }),
        getConfig("DQ_PENALTY_WEIGHT", 0.5),
        getConfig("DQ_CRITICAL_WEIGHT", 2.0),
        getConfig("DQ_STALE_HOURS", 24)
    ]);

    const checks: DqCheckResult[] = [];

    // --- MAPPING RESULTS ---

    // Rule 1
    checks.push({
        scope: "Staging",
        table: "tbl_base_products",
        rule: "Completeness: Missing Titles",
        description: "Sản phẩm bị thiếu tên (title là NULL)",
        failed_count: missingTitles,
        severity: "HIGH"
    });

    // Rule 2
    checks.push({
        scope: "Staging",
        table: "tbl_base_products",
        rule: "Validity: Invalid Price",
        description: "Sản phẩm có giá bán (price_sale) <= 0",
        failed_count: invalidPrices,
        severity: "CRITICAL"
    });

    // Rule 3
    checks.push({
        scope: "Warehouse",
        table: "fact_inventory_snapshot",
        rule: "Consistency: Negative Stock",
        description: "Bản ghi tồn kho có số lượng stock < 0",
        failed_count: negativeStock,
        severity: "MEDIUM"
    });

    // Rule 4
    checks.push({
        scope: "Warehouse",
        table: "fact_reviews",
        rule: "Completeness: Missing Rating",
        description: "Đánh giá bị thiếu điểm số (rating là NULL)",
        failed_count: missingRatings,
        severity: "LOW"
    });

    // Rule 5
    checks.push({
        scope: "Staging",
        table: "tbl_base_shop_info",
        rule: "Completeness: Unknown Region",
        description: "Cửa hàng bị thiếu thông tin khu vực (region là NULL)",
        failed_count: shopsNoRegion,
        severity: "LOW"
    });

    // Rule 6 (Raw query returns BigInt, convert to Number)
    const priceAnomalyCount = Number(priceAnomalyRaw[0]?.count || 0);
    checks.push({
        scope: "Staging",
        table: "tbl_base_products",
        rule: "Logic: Sale > Original Price",
        description: "Giá bán khuyến mãi (price_sale) cao hơn giá gốc (original price)",
        failed_count: priceAnomalyCount,
        severity: "HIGH"
    });

    // Rule 7: Data Freshness (Kiểm tra nếu dữ liệu cũ hơn 24h)
    let isStale = false;
    let hoursDiff = 0;
    if (latestRawData?.load_timestamp) {
        const now = new Date();
        const lastLoad = new Date(latestRawData.load_timestamp);
        hoursDiff = Math.abs(now.getTime() - lastLoad.getTime()) / 36e5;

        if (hoursDiff > Number(staleHoursLimit)) isStale = true;
    }


    checks.push({
        scope: "System",
        table: "Pipeline",
        rule: "Timeliness: Stale Data",
        description: `Không có dữ liệu mới được nạp trong ${staleHoursLimit} giờ qua (Độ trễ: ${hoursDiff.toFixed(1)}h)`,
        failed_count: isStale ? 1 : 0, // 1 nghĩa là Fail
        severity: "MEDIUM"
    });

    // --- SCORING LOGIC ---
    const totalIssues = checks.reduce((acc, curr) => acc + curr.failed_count, 0);

    let penalty = 0;
    checks.forEach(c => {
        if (c.failed_count > 0) {
            // Dùng biến criticalWeight
            const weight = c.severity === "CRITICAL" ? Number(criticalWeight) : c.severity === "HIGH" ? 2 : 1;

            // Dùng biến penaltyWeight
            penalty += Math.log10(c.failed_count + 1) * weight * Number(penaltyWeight);
        }
    });

    const healthScore = Math.max(0, Math.min(100, 100 - penalty));

    const lastCheckTime = new Date().toLocaleString('vi-VN');

    return { checks, healthScore, totalIssues, lastCheckTime };
}

export default async function DataQualityPage() {
    const { checks, healthScore, totalIssues, lastCheckTime } = await runDataQualityChecks();

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <h1 className="text-2xl font-bold flex items-center gap-2">
                    Kiểm Tra Chất Lượng Dữ Liệu (Data Quality Health Check)
                </h1>
                <div className="flex items-center gap-2 text-default-500 text-sm bg-default-100 px-3 py-1 rounded-full">
                    <ActivityIcon size={14} />
                    <span>Lần Quét Cuối: <strong>{lastCheckTime}</strong></span>
                </div>
            </div>

            {/* Grid Summary */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">

                {/* Health Score Card */}
                <Card className="md:col-span-2">
                    <CardHeader className="pb-0">
                        <h3 className="font-semibold text-lg">Điểm Số Sức Khỏe Dữ Liệu Tổng Thể</h3>
                    </CardHeader>
                    <CardBody className="gap-4">
                        <div className="flex items-center gap-4">
                            <span className={`text-4xl font-bold ${healthScore >= 80 ? 'text-success' : healthScore >= 50 ? 'text-warning' : 'text-danger'}`}>
                                {healthScore.toFixed(1)}%
                            </span>
                            <div className="flex-1">
                                <Progress
                                    aria-label="Điểm Sức Khỏe"
                                    value={healthScore}
                                    color={healthScore >= 80 ? "success" : healthScore >= 50 ? "warning" : "danger"}
                                    className="max-w-full"
                                    size="md"
                                    showValueLabel={true}
                                />
                            </div>
                        </div>
                        <p className="text-default-500 text-sm">
                            Đã phát hiện <strong>{new Intl.NumberFormat('vi-VN').format(totalIssues)}</strong> lỗi bất thường trên {checks.length} quy tắc kiểm tra.
                        </p>
                    </CardBody>
                </Card>

                {/* Quick Stats Card */}
                <Card>
                    <CardBody className="flex flex-col justify-center gap-4 h-full">
                        <div className="flex items-center justify-between p-2 bg-success-50 rounded-lg">
                            <div className="flex items-center gap-2">
                                <CheckCircleIcon size={18} className="text-success" />
                                <span className="text-sm font-medium">Đạt</span>
                            </div>
                            <span className="font-bold text-success text-lg">{checks.filter(c => c.failed_count === 0).length}</span>
                        </div>
                        <div className="flex items-center justify-between p-2 bg-danger-50 rounded-lg">
                            <div className="flex items-center gap-2">
                                <XCircleIcon size={18} className="text-danger" />
                                <span className="text-sm font-medium">Lỗi</span>
                            </div>
                            <span className="font-bold text-danger text-lg">{checks.filter(c => c.failed_count > 0).length}</span>
                        </div>
                        <div className="flex items-center gap-2 text-default-400 text-xs px-2">
                            <ClockIcon size={12} />
                            <span>Tự động làm mới sau mỗi 24h</span>
                        </div>
                    </CardBody>
                </Card>
            </div>

            {/* Rules Detail Table (Client Component) */}
            <Card>
                <CardHeader>
                    <h3 className="font-semibold text-lg">Báo Cáo Kiểm Tra Chi Tiết</h3>
                </CardHeader>
                <CardBody className="p-0">
                    <DataQualityTable checks={checks} />
                </CardBody>
            </Card>
        </div>
    );
}

================
File: app/playground/page.tsx
================
"use client";

import { useEffect, useRef, useState } from "react";
import Editor, { Monaco } from "@monaco-editor/react";
import { Button } from "@heroui/button";
import { Card, CardBody } from "@heroui/card";
import { Table, TableHeader, TableColumn, TableBody, TableRow, TableCell } from "@heroui/table";
import { PlayIcon, EraserIcon, AlertTriangleIcon, DatabaseIcon, HistoryIcon, Trash2Icon, ClockIcon, TypeIcon, HashIcon, CalendarIcon, TableIcon } from "lucide-react";
import { executeRawQuery, getDatabaseMetadata } from "@/app/actions/playground";
import { Spinner } from "@heroui/spinner";
import { Tab, Tabs } from '@heroui/tabs'
import { ScrollShadow } from "@heroui/scroll-shadow";
import { Accordion, AccordionItem } from "@heroui/accordion";
import { Chip } from "@heroui/chip";

const SQL_KEYWORDS = [
    "SELECT", "FROM", "WHERE", "GROUP BY", "ORDER BY", "LIMIT", "JOIN", "LEFT JOIN",
    "INNER JOIN", "ON", "AND", "OR", "NOT", "NULL", "IN", "BETWEEN", "LIKE", "AS",
    "COUNT", "SUM", "AVG", "MAX", "MIN", "DISTINCT", "INSERT", "UPDATE", "DELETE", "WITH"
];

interface HistoryItem {
    query: string;
    timestamp: number;
    status: "success" | "error";
}

interface ColumnInfo {
    name: string;
    type: string;
}
interface SchemaStructure {
    [schema: string]: {
        [table: string]: ColumnInfo[];
    };
}

const getDataTypeIcon = (type: string) => {
    if (type.includes('int') || type.includes('numeric') || type.includes('double')) return <HashIcon size={12} className="text-blue-400" />;
    if (type.includes('char') || type.includes('text')) return <TypeIcon size={12} className="text-orange-400" />;
    if (type.includes('date') || type.includes('time')) return <CalendarIcon size={12} className="text-green-400" />;
    return <DatabaseIcon size={12} className="text-default-400" />;
}

export default function SqlPlaygroundPage() {
    const [query, setQuery] = useState("SELECT * FROM \"warehouse\".\"dim_product\" LIMIT 10;");
    const [result, setResult] = useState<any[]>([]);
    const [columns, setColumns] = useState<string[]>([]);
    const [error, setError] = useState("");
    const [isLoading, setIsLoading] = useState(false);
    const [schemaData, setSchemaData] = useState<SchemaStructure>({})
    const [history, setHistory] = useState<HistoryItem[]>([]);
    const monacoRef = useRef<Monaco | null>(null);
    const editorRef = useRef<any>(null);
    const schemaDataRef = useRef<SchemaStructure>({});

    useEffect(() => {
        // Load Schema
        getDatabaseMetadata().then((res) => {
            if (res.success && res.data) {
                const data = res.data as SchemaStructure;
                setSchemaData(data);
                schemaDataRef.current = data;
            }
        });

        const savedHistory = localStorage.getItem("sql_history");
        if (savedHistory) {
            try {
                setHistory(JSON.parse(savedHistory));
            } catch (e) { console.error("Lỗi phân tích lịch sử", e); }
        }
    }, []);

    const insertToEditor = (text: string) => {
        if (editorRef.current) {
            const editor = editorRef.current;
            const position = editor.getPosition();
            editor.executeEdits("", [{
                range: {
                    startLineNumber: position.lineNumber,
                    startColumn: position.column,
                    endLineNumber: position.lineNumber,
                    endColumn: position.column
                },
                text: text,
                forceMoveMarkers: true
            }]);
            editor.focus();
        }
    };

    const handleEditorDidMount = (editor: any, monaco: Monaco) => {
        monacoRef.current = monaco;

        // Đăng ký Provider gợi ý code
        monaco.languages.registerCompletionItemProvider("sql", {
            triggerCharacters: ['.', ' '],
            provideCompletionItems: (model, position) => {
                const word = model.getWordUntilPosition(position);
                const range = {
                    startLineNumber: position.lineNumber,
                    endLineNumber: position.lineNumber,
                    startColumn: word.startColumn,
                    endColumn: word.endColumn,
                };

                const suggestions: any[] = [];

                SQL_KEYWORDS.forEach(kw => {
                    suggestions.push({
                        label: kw,
                        kind: monaco.languages.CompletionItemKind.Keyword,
                        insertText: kw,
                        range: range,
                    });
                });

                const currentSchema = schemaDataRef.current; // Lấy dữ liệu mới nhất từ Ref

                Object.keys(currentSchema).forEach(schema => {
                    Object.keys(currentSchema[schema]).forEach(table => {
                        // Suggest Table (Schema.Table)
                        suggestions.push({
                            label: `${schema}.${table}`, // Gợi ý full
                            kind: monaco.languages.CompletionItemKind.Class,
                            insertText: `"${schema}"."${table}"`, // Tự động quote
                            detail: "Bảng",
                            range: range,
                        });

                        // Suggest Table (Short name)
                        suggestions.push({
                            label: table,
                            kind: monaco.languages.CompletionItemKind.Class,
                            insertText: table,
                            detail: `Bảng (${schema})`,
                            range: range,
                        });

                        // Suggest Columns
                        currentSchema[schema][table].forEach(col => {
                            suggestions.push({
                                label: col.name,
                                kind: monaco.languages.CompletionItemKind.Field,
                                insertText: col.name,
                                detail: `${col.type} (${table})`,
                                range: range,
                            });
                        });
                    });
                });

                return { suggestions: suggestions };
            }
        });
    };

    const handleRunQuery = async () => {
        setIsLoading(true);
        setError("");
        setResult([]);

        const res = await executeRawQuery(query);

        const newHistoryItem: HistoryItem = {
            query: query,
            timestamp: Date.now(),
            status: res.error ? "error" : "success"
        };

        const updatedHistory = [newHistoryItem, ...history].slice(0, 50);
        setHistory(updatedHistory);
        localStorage.setItem("sql_history", JSON.stringify(updatedHistory));

        if (res.error) {
            setError(res.error);
        } else if (res.data && Array.isArray(res.data)) {
            setResult(res.data);
            if (res.data.length > 0) {
                setColumns(Object.keys(res.data[0]));
            }
        }
        setIsLoading(false);
    };

    const clearHistory = () => {
        setHistory([]);
        localStorage.removeItem("sql_history");
    }

    const loadQueryFromHistory = (q: string) => {
        setQuery(q);
    }

    return (
        <div className="flex h-[calc(100vh-100px)] gap-4">
            {/* --- LEFT SIDEBAR: SCHEMA & HISTORY --- */}
            <Card className="w-80 flex-none h-full flex flex-col">
                <Tabs aria-label="Tùy Chọn Sandbox" fullWidth size="sm" variant="underlined">

                    {/* TAB 1: DATABASE SCHEMA */}
                    <Tab key="schema" title={<div className="flex items-center gap-2"><DatabaseIcon size={14} /> Sơ Đồ Dữ Liệu</div>}>
                        <ScrollShadow className="h-[calc(100vh-180px)] p-2">
                            {/* Level 1: SCHEMA */}
                            <Accordion selectionMode="multiple" isCompact itemClasses={{ title: "font-bold text-sm text-primary" }}>
                                {Object.keys(schemaData).map((schema) => (
                                    <AccordionItem key={schema} title={schema} aria-label={schema}>
                                        {/* Level 2: TABLES (Nested Accordion) */}
                                        <Accordion
                                            selectionMode="multiple"
                                            isCompact
                                            showDivider={false}
                                            itemClasses={{
                                                trigger: "py-1 px-0",
                                                title: "text-xs font-semibold text-default-700",
                                                content: "pb-2 pl-2"
                                            }}
                                        >
                                            {Object.keys(schemaData[schema]).map(table => (
                                                <AccordionItem
                                                    key={table}
                                                    title={
                                                        <div className="flex items-center gap-2">
                                                            <TableIcon size={14} className="text-default-400" />
                                                            <span>{table}</span>
                                                            <span className="text-[10px] text-default-400 font-normal">
                                                                ({schemaData[schema][table].length})
                                                            </span>
                                                        </div>
                                                    }
                                                    aria-label={table}
                                                >
                                                    {/* Level 3: COLUMNS LIST */}
                                                    <div className="flex flex-col border-l-2 border-default-100 ml-1 pl-2 gap-1">
                                                        {schemaData[schema][table].map((col) => (
                                                            <div
                                                                key={col.name}
                                                                className="group flex items-center justify-between text-xs py-1 px-2 rounded hover:bg-default-100 cursor-pointer transition-colors"
                                                                onClick={() => insertToEditor(col.name)}
                                                                title={`Nhấn để chèn: ${col.name}`}
                                                            >
                                                                <div className="flex items-center gap-2 overflow-hidden">
                                                                    {getDataTypeIcon(col.type)}
                                                                    <span className="truncate text-default-600 font-mono group-hover:text-primary">
                                                                        {col.name}
                                                                    </span>
                                                                </div>
                                                                <span className="text-[10px] text-default-300 ml-2 font-mono shrink-0">
                                                                    {col.type}
                                                                </span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </AccordionItem>
                                            ))}
                                        </Accordion>
                                    </AccordionItem>
                                ))}
                            </Accordion>
                        </ScrollShadow>
                    </Tab>
                    {/* TAB 2: QUERY HISTORY */}
                    <Tab key="history" title={<div className="flex items-center gap-2"><HistoryIcon size={14} /> Lịch Sử Truy Vấn</div>}>
                        <div className="flex flex-col h-full">
                            <div className="flex justify-end p-2 border-b border-default-100">
                                <Button size="sm" color="danger" variant="light" startContent={<Trash2Icon size={14} />} onPress={clearHistory}>
                                    Xóa Toàn Bộ
                                </Button>
                            </div>
                            <ScrollShadow className="h-[calc(100vh-220px)]">
                                {history.map((item, idx) => (
                                    <div
                                        key={idx}
                                        onClick={() => loadQueryFromHistory(item.query)}
                                        className="p-3 border-b border-default-100 cursor-pointer hover:bg-default-100 transition-colors group"
                                    >
                                        <div className="flex justify-between items-start mb-1">
                                            <Chip size="sm" variant="dot" color={item.status === 'success' ? 'success' : 'danger'} className="scale-75 origin-left">
                                                {item.status === 'success' ? 'Thành công' : 'Thất bại'}
                                            </Chip>
                                            <span className="text-[10px] text-default-400 flex items-center gap-1">
                                                <ClockIcon size={10} />
                                                {new Date(item.timestamp).toLocaleTimeString()}
                                            </span>
                                        </div>
                                        <p className="text-xs font-mono text-default-600 line-clamp-3 group-hover:text-primary">
                                            {item.query}
                                        </p>
                                    </div>
                                ))}
                                {history.length === 0 && (
                                    <div className="text-center text-default-400 text-sm mt-10">Chưa có lịch sử nào.</div>
                                )}
                            </ScrollShadow>
                        </div>
                    </Tab>
                </Tabs>
            </Card>

            {/* --- RIGHT CONTENT: EDITOR & RESULT --- */}
            <div className="flex-1 flex flex-col gap-4 h-full min-w-0">

                {/* Toolbar */}
                <div className="flex justify-between items-center bg-content1 p-2 rounded-lg border border-default-200">
                    <h1 className="text-xl font-bold ml-2">Trình Chỉnh Sửa SQL</h1>
                    <div className="flex gap-2">
                        <Button
                            color="danger"
                            variant="flat"
                            size="sm"
                            onPress={() => setQuery("")}
                            startContent={<EraserIcon size={16} />}
                        >
                            Xóa
                        </Button>
                        <Button
                            color="primary"
                            isLoading={isLoading}
                            onPress={handleRunQuery}
                            startContent={!isLoading && <PlayIcon size={16} />}
                            size="sm"
                        >
                            Chạy Truy Vấn (Ctrl+Enter)
                        </Button>
                    </div>
                </div>

                {/* Editor */}
                <Card className="flex-none h-[350px] border border-default-200">
                    <Editor
                        height="100%"
                        defaultLanguage="sql"
                        theme="vs-dark"
                        value={query}
                        onChange={(value) => setQuery(value || "")}
                        onMount={handleEditorDidMount} // Đăng ký Autocomplete ở đây
                        options={{
                            minimap: { enabled: false },
                            fontSize: 14,
                            scrollBeyondLastLine: false,
                            automaticLayout: true,
                            suggestOnTriggerCharacters: true, // Kích hoạt gợi ý khi gõ
                        }}
                    />
                </Card>

                {/* Error Message */}
                {error && (
                    <div className="p-3 bg-danger-50 border border-danger-200 text-danger rounded-lg flex items-center gap-2 text-sm">
                        <AlertTriangleIcon size={18} />
                        <span className="font-mono">{error}</span>
                    </div>
                )}

                {/* Result Table */}
                 <Card className="flex-1 w-full overflow-hidden min-h-[100px]">
                    {/* Thêm overflow-auto vào CardBody để cuộn nội dung bên trong Card */}
                    <CardBody className="p-0 h-full overflow-auto scrollbar-hide">
                        {result.length > 0 ? (
                            <Table
                                aria-label="Kết Quả Truy Vấn"
                                isHeaderSticky
                                removeWrapper
                                classNames={{
                                    // Bỏ h-full ở base để tránh xung đột chiều cao khi scroll ngang
                                    base: "min-w-full",
                                    table: "min-w-full",
                                }}
                            >
                                <TableHeader>
                                    {columns.map((col) => (
                                        <TableColumn key={col} className="whitespace-nowrap">
                                            {/* Thêm whitespace-nowrap để tên cột không bị xuống dòng */}
                                            {col.toUpperCase()}
                                        </TableColumn>
                                    ))}
                                </TableHeader>
                                <TableBody>
                                    {result.map((row, idx) => (
                                        <TableRow key={idx}>
                                            {columns.map((col) => (
                                                <TableCell key={`${idx}-${col}`}>
                                                    <div className="max-w-[300px] truncate font-mono text-xs" title={String(row[col])}>
                                                        {typeof row[col] === 'object' && row[col] !== null
                                                            ? JSON.stringify(row[col])
                                                            : String(row[col])}
                                                    </div>
                                                </TableCell>
                                            ))}
                                        </TableRow>
                                    ))}
                                </TableBody>
                            </Table>
                        ) : (
                            <div className="h-full flex flex-col items-center justify-center text-default-400">
                                {isLoading ? <Spinner label="Đang thực thi truy vấn..." /> : "Không có kết quả. Hãy chạy một truy vấn hoặc chọn từ lịch sử."}
                            </div>
                        )}
                    </CardBody>
                </Card>
            </div>
        </div>
    );
}

================
File: app/products/[id]/page.tsx
================
import { prisma } from "@/lib/prisma";
import { Card, CardBody, CardHeader } from "@heroui/card";
import { Chip } from "@heroui/chip";
import { User } from "@heroui/user";
import { ProductHistoryChart } from "@/components/product-history-chart";
import { ArrowLeftIcon, CalendarIcon, StoreIcon } from "lucide-react";
import Link from "next/link";
import { Button } from "@heroui/button";
// Import component bảng đã tách ra để tránh lỗi Server Component
import { ProductVersionHistoryTable } from "@/components/product-version-history-table";

// Hàm lấy dữ liệu chi tiết sản phẩm từ Warehouse
async function getProductDetail(productId: string) {
  // 1. Lấy thông tin Dimension hiện tại (Current Version)
  const currentDim = await prisma.dim_product.findFirst({
    where: { 
      product_id: productId,
      is_current: true 
    }
  });

  // Nếu không tìm thấy sản phẩm hiện tại, trả về null
  if (!currentDim) return null;

  // 2. Lấy lịch sử biến động giá/kho từ Fact Table (Inventory Snapshot)
  // Join với Dim Date để lấy ngày tháng hiển thị cho biểu đồ
  const historyRaw: any[] = await prisma.$queryRaw`
    SELECT 
      d.full_date,
      f.stock,
      f.price_real
    FROM "warehouse"."fact_inventory_snapshot" f
    JOIN "warehouse"."dim_sku" s ON f.sku_key = s.sku_key
    JOIN "warehouse"."dim_date" d ON f.date_key = d.date_key
    WHERE s.product_key = ${currentDim.product_key}
    ORDER BY d.full_date ASC
    LIMIT 30 -- Lấy 30 ngày gần nhất
  `;

  // 3. Lấy lịch sử thay đổi thông tin (SCD Type 2 History)
  // Xem sản phẩm này đã thay đổi tiêu đề/mô tả/danh mục bao nhiêu lần
  const versionHistory = await prisma.dim_product.findMany({
    where: { product_id: productId },
    orderBy: { valid_from: 'desc' },
    select: {
      title: true,
      valid_from: true,
      valid_to: true,
      is_current: true,
      description: true,
      categories: true
    }
  });

  return {
    info: currentDim,
    // Map dữ liệu cho Recharts
    chartData: historyRaw.map(item => ({
        date: new Date(item.full_date).toLocaleDateString('vi-VN', {day: '2-digit', month: '2-digit'}),
        price: Number(item.price_real),
        stock: item.stock
    })),
    versions: versionHistory
  };
}

export default async function ProductDetailPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  // Decode ID vì URL có thể chứa ký tự đặc biệt (ví dụ dấu cách, tiếng Việt)
  const decodedId = decodeURIComponent(id);
  const data = await getProductDetail(decodedId);

  if (!data) {
    return (
        <div className="flex flex-col items-center justify-center h-[50vh] gap-4">
            <h2 className="text-xl font-bold text-default-500">Không tìm thấy Sản phẩm trong Warehouse</h2>
            <Link href="/products">
                <Button color="primary" variant="flat">Quay lại Danh sách</Button>
            </Link>
        </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* 1. Header & Back Button */}
      <div className="flex items-center gap-4">
        <Link href="/products">
          <Button isIconOnly variant="flat" size="sm"><ArrowLeftIcon size={20}/></Button>
        </Link>
        <div>
            <h1 className="text-xl font-bold flex items-center gap-2">
                Chế độ Xem Toàn diện Sản phẩm (360 View)
                <Chip size="sm" color="success" variant="flat">Dữ liệu Warehouse</Chip>
            </h1>
            <p className="text-default-500 text-sm font-mono">ID: {decodedId}</p>
        </div>
      </div>

      {/* 2. Main Content Grid: Info & Chart */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        {/* Left Column: Product Information */}
        <Card className="lg:col-span-1 h-full">
            <CardHeader>
                <h3 className="font-semibold text-lg">Thông tin Dimension Hiện tại</h3>
            </CardHeader>
            <CardBody className="flex flex-col gap-5">
                <User 
                    name={<span className="text-lg font-semibold line-clamp-2">{data.info.title}</span>}
                    description={data.info.product_id}
                    avatarProps={{ radius: "lg", size: "lg", isBordered: true }}
                />
                
                <div className="space-y-3">
                    <div className="flex items-center justify-between text-sm p-2 bg-default-100 rounded-lg">
                        <div className="flex items-center gap-2 text-default-500">
                            <StoreIcon size={16} />
                            <span>ID Người Bán</span>
                        </div>
                        <span className="font-mono font-bold">{data.info.seller_id}</span>
                    </div>

                    <div className="flex items-center justify-between text-sm p-2 bg-default-100 rounded-lg">
                        <div className="flex items-center gap-2 text-default-500">
                            <CalendarIcon size={16} />
                            <span>Có hiệu lực từ</span>
                        </div>
                        <span>{data.info.valid_from ? new Date(data.info.valid_from).toLocaleDateString('vi-VN') : 'N/A'}</span>
                    </div>
                </div>
                
                <div className="p-3 border border-default-200 rounded-lg text-sm bg-background">
                    <p className="font-semibold mb-2 text-default-600">Ảnh chụp Mô tả:</p>
                    <p className="line-clamp-[8] text-default-500 leading-relaxed">
                        {data.info.description || "Không có mô tả nào."}
                    </p>
                </div>
            </CardBody>
        </Card>

        {/* Right Column: Price & Stock Chart */}
        <div className="lg:col-span-2">
             <ProductHistoryChart data={data.chartData} />
        </div>
      </div>

      {/* 3. Bottom Section: Version History Table (SCD Type 2) */}
      <Card>
        <CardHeader>
            <div className="flex flex-col">
                <h3 className="font-semibold text-lg">Lịch sử Dimension</h3>
                <p className="text-small text-default-500">Theo dõi Dimension Thay đổi Chậm (SCD Loại 2)</p>
            </div>
        </CardHeader>
        <CardBody>
            <ProductVersionHistoryTable versions={data.versions} />
        </CardBody>
      </Card>
    </div>
  );
}

================
File: app/products/page.tsx
================
import { prisma } from "@/lib/prisma";
import { BaseProductsTable } from "@/components/base-products-table";
import SearchInput from "@/components/search-input";
import { serializeData } from "@/lib/utils";

const ITEMS_PER_PAGE = 10;

export default async function ProductsPage({
  searchParams,
}: {
  searchParams: Promise<{ query?: string; page?: string }>;
}) {
  const params = await searchParams;
  const query = params?.query || "";
  const page = Number(params?.page) || 1;
  const skip = (page - 1) * ITEMS_PER_PAGE;

  const whereCondition = query
    ? {
        OR: [
          { title: { contains: query, mode: "insensitive" as const } },
          { product_id: { contains: query, mode: "insensitive" as const } },
        ],
      }
    : {};

  const [products, totalCount] = await prisma.$transaction([
    prisma.tbl_base_products.findMany({
      where: whereCondition,
      skip,
      take: ITEMS_PER_PAGE,
      orderBy: { load_timestamp: "desc" },
    }),
    prisma.tbl_base_products.count({ where: whereCondition }),
  ]);

  const totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE);
  const serializedProducts = serializeData(products);

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold">Sản Phẩm Đã Làm Sạch (Staging)</h1>
        <SearchInput placeholder="Tìm kiếm theo tên hoặc ID..." />
      </div>
      <BaseProductsTable products={serializedProducts} totalPages={totalPages} />
    </div>
  );
}

================
File: app/settings/page.tsx
================
import { getAllSettings } from "@/app/actions/settings";
import MaintenancePanel from "@/components/maintenance-panel";
import SettingsEditor from "@/components/settings-editor";

export default async function SettingsPage() {
  const result = await getAllSettings();

  if (result.error || !result.data) {
    return (
      <div className="flex items-center justify-center h-full text-lg text-danger-600 font-semibold bg-danger-50 border border-danger-200 rounded-lg p-6">
        Lỗi khi tải cấu hình hệ thống.
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold">Cấu Hình Hệ Thống</h1>
      <SettingsEditor settings={result.data} />
      <MaintenancePanel />
    </div>
  );
}

================
File: app/layout.tsx
================
import "@/styles/globals.css";
import { Metadata } from "next";
import { Providers } from "./providers";
import { fontSans, fontMono } from "@/config/fonts";
import { Sidebar } from "@/components/sidebar";
import { SidebarProvider } from "@/components/sidebar-context"; // Import 1
import { MainLayout } from "@/components/main-layout"; // Import 2
import clsx from "clsx";

export const metadata: Metadata = {
  title: "Data Warehouse Admin",
  description: "Manage crawl sources and view data",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body
        className={clsx(
          "min-h-screen bg-background font-sans antialiased",
          fontSans.variable,
          fontMono.variable
        )}
      >
        <Providers themeProps={{ attribute: "class", defaultTheme: "dark" }}>
          {/* Bọc toàn bộ app trong SidebarProvider */}
          <SidebarProvider>
            <div className="flex min-h-screen">
              
              <Sidebar />
              
              <MainLayout>
                {children}
              </MainLayout>
              
            </div>
          </SidebarProvider>
        </Providers>
      </body>
    </html>
  );
}

================
File: app/page.tsx
================
import { Card, CardBody, CardHeader } from "@heroui/card";
import { DatabaseIcon, AlertCircleIcon, PackageIcon } from "lucide-react";
import { prisma } from "@/lib/prisma";
import { serializeData } from "@/lib/utils";
import { DashboardChart } from "@/components/dashboard-chart";
import { RecentLogsTable } from "@/components/recent-logs-table"; 

async function getDashboardStats() {
  const startOfToday = new Date();
  startOfToday.setHours(0, 0, 0, 0);

  const [activeSources, totalProducts, failedJobsToday, recentLogs] = await prisma.$transaction([
    prisma.source_config.count({ where: { is_active: true } }),
    
    prisma.tbl_products_raw.count(),
    
    prisma.crawled_files_log.count({
      where: { status: "FAILED", created_at: { gte: startOfToday } }
    }),

    prisma.crawled_files_log.findMany({
      take: 5,
      orderBy: { created_at: "desc" },
      include: { source_config: true }
    })
  ]);
  const chartRawData: any[] = await prisma.$queryRaw`
    SELECT 
      TO_CHAR(load_timestamp, 'DD/MM') as date, 
      COUNT(*)::int as count 
    FROM "staging"."tbl_products_raw"
    WHERE load_timestamp >= NOW() - INTERVAL '7 days'
    GROUP BY TO_CHAR(load_timestamp, 'DD/MM'), DATE(load_timestamp)
    ORDER BY DATE(load_timestamp) ASC
  `;

  return {
    activeSources,
    totalProducts,
    failedJobsToday,
    recentLogs: serializeData(recentLogs),
    chartData: chartRawData 
  };
}

export default async function Dashboard() {
  const stats = await getDashboardStats();

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold">Tổng Quan Dashboard</h1>
      
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <StatsCard 
          title="Nguồn Dữ Liệu Hoạt Động (active data source)" 
          value={stats.activeSources} 
          icon={<DatabaseIcon className="text-primary" size={24} />} 
        />
        <StatsCard 
          title="Sản Phẩm Thô (raw product)" 
          value={new Intl.NumberFormat('vi-VN').format(stats.totalProducts)} 
          icon={<PackageIcon className="text-success" size={24} />} 
        />
        <StatsCard 
          title="Lỗi Pipeline Hôm Nay" 
          value={stats.failedJobsToday} 
          icon={<AlertCircleIcon className="text-danger" size={24} />} 
        />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
        
        <DashboardChart data={stats.chartData} />

        <Card className="lg:col-span-1 min-h-[400px]">
          <CardHeader>
            <h3 className="font-semibold text-lg">Hoạt Động Crawl Gần Đây</h3>
          </CardHeader>
          <CardBody>
             <RecentLogsTable logs={stats.recentLogs} />
          </CardBody>
        </Card>
      </div>
    </div>
  );
}

const StatsCard = ({ title, value, icon }: any) => (
  <Card>
    <CardBody className="flex flex-row items-center gap-4 p-6">
      <div className="p-3 bg-default-100 rounded-large">
        {icon}
      </div>
      <div>
        <p className="text-small text-default-500 uppercase font-bold">{title}</p>
        <h4 className="text-3xl font-bold">{value}</h4>
      </div>
    </CardBody>
  </Card>
);

================
File: components/base-products-table.tsx
================
"use client";

import { Table, TableHeader, TableColumn, TableBody, TableRow, TableCell } from "@heroui/table";
import { User } from "@heroui/user";
import { Pagination } from "@heroui/pagination";
import { useRouter, usePathname, useSearchParams } from "next/navigation";
import Link from "next/link";

export const BaseProductsTable = ({ products, totalPages }: { products: any[], totalPages: number }) => {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();
  const currentPage = Number(searchParams.get("page")) || 1;

  const handlePageChange = (page: number) => {
    const params = new URLSearchParams(searchParams);
    params.set("page", page.toString());
    router.push(`${pathname}?${params.toString()}`);
  };

  return (
    <Table
      aria-label="Bảng sản phẩm cơ sở"
      className="font-sans"
      bottomContent={
        totalPages > 1 && (
          <div className="flex w-full justify-center">
             <Pagination
                showControls
                showShadow
                color="primary"
                page={currentPage}
                total={totalPages}
                onChange={handlePageChange}
             />
          </div>
        )
      }
    >
      <TableHeader>
        <TableColumn>SẢN PHẨM</TableColumn>
        <TableColumn>GIÁ BÁN</TableColumn>
        <TableColumn>ĐÃ BÁN</TableColumn>
        <TableColumn>NGƯỜI BÁN</TableColumn>
        <TableColumn>CẬP NHẬT CUỐI</TableColumn>
      </TableHeader>
      <TableBody emptyContent="Không tìm thấy sản phẩm nào">
        {products.map((item) => {
          // Logic xử lý ảnh an toàn (Vì JSONB có thể trả về string hoặc array tùy driver/data)
          let images: string[] = [];
          try {
            if (Array.isArray(item.images)) {
                images = item.images;
            } else if (typeof item.images === 'string') {
                images = JSON.parse(item.images);
            }
          } catch (e) {
            images = [];
          }
          
          // Lấy ảnh đầu tiên làm avatar
          const avatarUrl = images.length > 0 ? images[0] : undefined;

          return (
            <TableRow key={item.id}>
              <TableCell>
                {/* Link dẫn đến trang chi tiết Warehouse View */}
                <Link href={`/products/${encodeURIComponent(item.product_id)}`}>
                    <div className="cursor-pointer group">
                        <User
                            avatarProps={{
                                radius: "lg",
                                src: avatarUrl,
                                fallback: "IMG",
                                className: "group-hover:scale-105 transition-transform" // Hiệu ứng phóng to ảnh khi hover
                            }}
                            description={item.product_id}
                            name={
                                <div 
                                    className="w-[250px] truncate font-medium text-foreground group-hover:text-primary transition-colors" 
                                    title={item.title}
                                >
                                    {item.title}
                                </div>
                            }
                        />
                    </div>
                </Link>
              </TableCell>
              <TableCell>
                <div className="font-bold text-success">
                    {new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.price_sale || 0)}
                </div>
                {/* Nếu có giá gốc và giá gốc lớn hơn giá bán thì hiển thị gạch ngang */}
                {item.price_original && Number(item.price_original) > Number(item.price_sale) && (
                    <div className="text-tiny text-default-400 line-through">
                        {new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.price_original)}
                    </div>
                )}
              </TableCell>
              <TableCell>{new Intl.NumberFormat('vi-VN').format(item.sold_count || 0)}</TableCell>
              <TableCell>{item.seller_id}</TableCell>
              <TableCell className="text-tiny text-default-400">
                {item.load_timestamp ? new Date(item.load_timestamp).toLocaleDateString('vi-VN') : ''}
              </TableCell>
            </TableRow>
          );
        })}
      </TableBody>
    </Table>
  );
};

================
File: components/logs-table.tsx
================
"use client";
import { useRouter, usePathname, useSearchParams } from "next/navigation";
import { Table, TableBody, TableCell, TableColumn, TableHeader, TableRow } from '@heroui/table';
import { Chip } from '@heroui/chip';
import { Pagination } from "@heroui/pagination";

interface Log {
  id: number;
  file_name: string;
  file_path: string;
  record_count: number | null;
  status: string;
  error_message: string | null;
  created_at: Date | null;
  source_config: { id: string };
}

export const LogsTable = ({ logs, totalPages }: { logs: Log[], totalPages: number }) => {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();
  const currentPage = Number(searchParams.get("page")) || 1;

  const handlePageChange = (page: number) => {
    const params = new URLSearchParams(searchParams);
    params.set("page", page.toString());
    router.push(`${pathname}?${params.toString()}`);
  };

  return (
    <Table 
      aria-label="Bảng lịch sử crawl"
      className="font-sans"
      bottomContent={
        totalPages > 1 && (
          <div className="flex w-full justify-center">
             <Pagination isCompact showControls page={currentPage} total={totalPages} onChange={handlePageChange} />
          </div>
        )
      }
    >
      <TableHeader>
        <TableColumn>ID</TableColumn>
        <TableColumn>ID NGUỒN</TableColumn>
        <TableColumn>TÊN FILE</TableColumn>
        <TableColumn>ĐƯỜNG DẪN FILE</TableColumn>
        <TableColumn>SỐ BẢN GHI</TableColumn>
        <TableColumn>TRẠNG THÁI</TableColumn>
        <TableColumn>THỜI GIAN</TableColumn>
      </TableHeader>
      <TableBody emptyContent="Không tìm thấy logs nào">
        {logs.map((log) => (
          <TableRow key={log.id}>
            <TableCell>#{log.id}</TableCell>
            <TableCell className="font-bold text-small">#{log.source_config?.id}</TableCell>
            <TableCell>{log.file_name}</TableCell>
            <TableCell>{log.file_path}</TableCell>
            <TableCell>{log.record_count ?? 0}</TableCell>
            <TableCell>
              <Chip color={log.status === "SUCCESS" ? "success" : log.status === "FAILED" ? "danger" : "warning"} size="sm" variant="flat">
                {log.status === "SUCCESS" ? "THÀNH CÔNG" : log.status === "FAILED" ? "THẤT BẠI" : "ĐANG CHẠY"}
              </Chip>
              {log.error_message && <div className="text-tiny text-danger max-w-[200px] truncate" title={log.error_message}>{log.error_message}</div>}
            </TableCell>
            <TableCell>{log.created_at ? new Date(log.created_at).toLocaleString('vi-VN') : ""}</TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  );
};

================
File: components/product-version-history-table.tsx
================
"use client";

import { Table, TableHeader, TableColumn, TableBody, TableRow, TableCell } from "@heroui/table";
import { Chip } from "@heroui/chip";
import { Button } from "@heroui/button";
import { GitCompareIcon, EyeIcon } from "lucide-react";
import { useState } from "react";
import { VersionDiffModal } from "./version-diff-modal";
import { Tooltip } from "@heroui/tooltip";

// Giả định props versions đã được sắp xếp giảm dần (Mới nhất -> Cũ nhất) từ Server
export const ProductVersionHistoryTable = ({ versions }: { versions: any[] }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [selectedVerIndex, setSelectedVerIndex] = useState<number>(-1);

    // Hàm mở modal so sánh
    const handleCompare = (index: number) => {
        setSelectedVerIndex(index);
        setIsModalOpen(true);
    };

    const handleClose = () => {
        setIsModalOpen(false);
        setSelectedVerIndex(-1);
    };

    // Xác định phiên bản để so sánh
    // selectedVer = versions[index]
    // previousVer = versions[index + 1] (Vì mảng sort giảm dần, index lớn hơn là bản ghi cũ hơn)
    const currentVer = selectedVerIndex >= 0 ? versions[selectedVerIndex] : null;
    const previousVer = selectedVerIndex >= 0 && selectedVerIndex < versions.length - 1
        ? versions[selectedVerIndex + 1]
        : null;

    return (
        <>
            <Table aria-label="Lịch sử phiên bản" removeWrapper className="font-sans">
                <TableHeader>
                    <TableColumn>CÓ HIỆU LỰC TỪ</TableColumn>
                    <TableColumn>KẾT THÚC HIỆU LỰC</TableColumn>
                    <TableColumn>TRẠNG THÁI</TableColumn>
                    <TableColumn>ẢNH CHỤP TIÊU ĐỀ</TableColumn>
                    <TableColumn align="end">HÀNH ĐỘNG</TableColumn>
                </TableHeader>
                <TableBody emptyContent="Không có dữ liệu lịch sử">
                    {versions.map((ver: any, idx: number) => (
                        <TableRow key={idx}>
                            <TableCell>
                                {ver.valid_from ? new Date(ver.valid_from).toLocaleString("vi-VN") : "N/A"}
                            </TableCell>
                            <TableCell>
                                {ver.valid_to && new Date(ver.valid_to).getFullYear() < 9000
                                    ? new Date(ver.valid_to).toLocaleString("vi-VN")
                                    : <span className="text-danger font-semibold">∞</span>} {/* Vô hạn và đánh dấu màu */}
                            </TableCell>
                            <TableCell>
                                <Chip
                                    size="sm"
                                    color={ver.is_current ? "success" : "default"}
                                    variant="flat"
                                >
                                    {ver.is_current ? "Hiện tại" : "Lịch sử"}
                                </Chip>
                            </TableCell>
                            <TableCell>
                                <div className="max-w-[300px] truncate text-default-500 italic" title={ver.title}>
                                    {ver.title}
                                </div>
                            </TableCell>
                            <TableCell>
                                <div className="flex justify-end gap-2">
                                    {/* Chỉ hiện nút Compare nếu không phải là bản ghi cuối cùng (cũ nhất) */}
                                    {idx < versions.length - 1 ? (
                                        <Tooltip content="So sánh với phiên bản trước">
                                            <Button
                                                isIconOnly
                                                size="sm"
                                                variant="light"
                                                color="primary"
                                                onPress={() => handleCompare(idx)}
                                            >
                                                <GitCompareIcon size={18} />
                                            </Button>
                                        </Tooltip>
                                    ) : (
                                        <Tooltip content="Phiên bản gốc (Không có lịch sử cũ hơn)">
                                            <Button isIconOnly size="sm" variant="light" disabled className="opacity-30 cursor-not-allowed">
                                                <EyeIcon size={18} />
                                            </Button>
                                        </Tooltip>
                                    )}
                                </div>
                            </TableCell>
                        </TableRow>
                    ))}
                </TableBody>
            </Table>

            {/* Modal So Sánh */}
            <VersionDiffModal
                isOpen={isModalOpen}
                onClose={handleClose}
                currentVersion={currentVer}
                previousVersion={previousVer}
            />
        </>
    );
};

================
File: components/sources-table.tsx
================
"use client";

import { Table, TableBody, TableCell, TableColumn, TableHeader, TableRow } from '@heroui/table';
import { Chip } from '@heroui/chip';
import { Tooltip } from '@heroui/tooltip'
import { EditIcon, TrashIcon, RefreshCwIcon } from "lucide-react";
import { useRouter, usePathname, useSearchParams } from "next/navigation";
import { Pagination } from '@heroui/pagination'
import { EditSourceModal } from '@/components/edit-source-modal';
import { deleteSource, triggerCrawl } from '@/app/actions/sources';
import { useState } from 'react';
import { Button } from '@heroui/button';

interface SourcesTableProps {
    sources: any[];
    totalPages: number;
}

const statusColorMap: Record<string, "success" | "danger" | "warning"> = {
    SUCCESS: "success",
    FAILED: "danger",
    PENDING: "warning",
};

export const SourcesTable = ({ sources, totalPages }: SourcesTableProps) => {
    const router = useRouter();
    const pathname = usePathname();
    const searchParams = useSearchParams();
    const [triggeringId, setTriggeringId] = useState<number | null>(null); 
    const [isDeleting, setIsDeleting] = useState<number | null>(null); // State cho nút xóa

    const currentPage = Number(searchParams.get("page")) || 1;

    const formatDate = (date: Date | null) => {
        if (!date) return "N/A";
        return new Date(date).toLocaleString('vi-VN');
    };

    const handlePageChange = (page: number) => {
        const params = new URLSearchParams(searchParams);
        params.set("page", page.toString());
        router.push(`${pathname}?${params.toString()}`);
    };
    
    // Thay thế `confirm()` bằng một thông báo console và tiến hành xóa
    const handleDelete = async (id: number, sourceName: string) => {
        // NOTE: Trong môi trường thực, cần dùng Modal UI thay vì confirm
        if (window.confirm(`Bạn có chắc chắn muốn xóa nguồn dữ liệu "${sourceName}" không? Hành động này không thể hoàn tác.`)) {
            setIsDeleting(id);
            await deleteSource(id);
            setIsDeleting(null);
            // Sau khi xóa, làm mới trang
            router.refresh(); 
        }
    };

    const handleTriggerCrawl = async (id: number) => {
        setTriggeringId(id);
        const result = await triggerCrawl(id);
        if (result.error) {
            // Thay thế alert() bằng console.error
            console.error("Lỗi kích hoạt crawl:", result.error);
        }
        setTriggeringId(null);
        // Sau khi kích hoạt, làm mới trang để cập nhật trạng thái
        router.refresh();
    };

    return (
        <Table
            aria-label="Bảng cấu hình nguồn dữ liệu"
            className="font-sans"
            bottomContent={
                totalPages > 1 ? (
                    <div className="flex w-full justify-center">
                        <Pagination
                            isCompact
                            showControls
                            showShadow
                            color="primary"
                            page={currentPage}
                            total={totalPages}
                            onChange={handlePageChange}
                        />
                    </div>
                ) : null
            }
        >
            <TableHeader>
                <TableColumn>ID</TableColumn>
                <TableColumn>TÊN NGUỒN</TableColumn>
                <TableColumn>TRẠNG THÁI</TableColumn>
                <TableColumn>LẦN CRAWL CUỐI</TableColumn>
                <TableColumn>HÀNH ĐỘNG</TableColumn>
            </TableHeader>
            <TableBody emptyContent={"Không có dòng nào để hiển thị."}>
                {sources.map((source) => (
                    <TableRow key={source.id}>
                        <TableCell>#{source.id}</TableCell>
                        <TableCell>
                            <div className="flex flex-col">
                                <span className="font-bold text-sm">{source.source_name}</span>
                                <span className="text-tiny text-default-400 truncate max-w-[200px]">
                                    {source.base_url}
                                </span>
                            </div>
                        </TableCell>
                        <TableCell>
                            <Chip
                                className="capitalize"
                                color={source.is_active ? "success" : "default"}
                                size="sm"
                                variant="flat"
                            >
                                {source.is_active ? "Hoạt động" : "Ngừng hoạt động"}
                            </Chip>
                        </TableCell>
                        <TableCell>
                            <div className="flex flex-col gap-1">
                                <Chip
                                    size="sm"
                                    color={statusColorMap[source.last_crawl_status || "PENDING"] || "default"}
                                    variant="dot"
                                >
                                    {source.last_crawl_status || "Chưa chạy"}
                                </Chip>
                                <span className="text-tiny text-default-400">
                                    {formatDate(source.last_crawl_timestamp)}
                                </span>
                            </div>
                        </TableCell>
                        <TableCell>
                            <div className="flex items-center gap-2">
                                <EditSourceModal source={source} />
                                <Tooltip color="danger" content="Xóa nguồn">
                                    <Button
                                        isIconOnly
                                        size="sm"
                                        variant="light"
                                        color="danger"
                                        onPress={() => handleDelete(source.id, source.source_name)}
                                        isLoading={isDeleting === source.id}
                                        disabled={isDeleting === source.id}
                                        className="text-lg text-danger cursor-pointer active:opacity-50 hover:opacity-100"
                                    >
                                        <TrashIcon size={18} />
                                    </Button>
                                </Tooltip>
                                <Tooltip content="Kích hoạt Crawl">
                                    <Button
                                        isIconOnly
                                        size="sm"
                                        variant="light"
                                        color="primary"
                                        onPress={() => handleTriggerCrawl(source.id)}
                                        isLoading={triggeringId === source.id}
                                        disabled={triggeringId === source.id}
                                        className="text-lg text-primary cursor-pointer active:opacity-50 hover:opacity-100"
                                    >
                                        <RefreshCwIcon size={18} className={triggeringId === source.id ? 'animate-spin' : ''} />
                                    </Button>
                                </Tooltip>
                            </div>
                        </TableCell>
                    </TableRow>
                ))}
            </TableBody>
        </Table>
    );
};

================
File: app/logs/page.tsx
================
import { prisma } from "@/lib/prisma";
import { LogsTable } from "@/components/logs-table";

const ITEMS_PER_PAGE = 10;

export default async function LogsPage({
  searchParams,
}: {
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>;
}) {
  const params = await searchParams;
  const page = Number(params?.page) || 1;
  const skip = (page - 1) * ITEMS_PER_PAGE;

  const [logs, totalCount] = await prisma.$transaction([
    prisma.crawled_files_log.findMany({
      skip,
      take: ITEMS_PER_PAGE,
      orderBy: { id: 'desc' },
      include: { 
        source_config: {
          select: { id: true }
        }
      }
    }),
    prisma.crawled_files_log.count()
  ]);

  const totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE);

  return (
    <div className="space-y-4">
      <h1 className="text-2xl font-bold">Lịch Sử Crawling Dữ Liệu</h1>
      <LogsTable logs={logs as any} totalPages={totalPages} />
    </div>
  );
}

================
File: prisma/schema.prisma
================
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["controller", "staging", "warehouse"]
}

model crawled_files_log {
  id               Int           @id @default(autoincrement())
  source_config_id Int
  file_name        String        @db.VarChar(255)
  file_path        String?       @db.VarChar(1024)
  record_count     Int?
  status           String        @default("PENDING") @db.VarChar(50)
  error_message    String?
  created_at       DateTime?     @default(now()) @db.Timestamptz(6)
  processed_at     DateTime?     @db.Timestamptz(6)
  source_config    source_config @relation(fields: [source_config_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@schema("controller")
}

model source_config {
  id                   Int                 @id @default(autoincrement())
  source_name          String              @db.VarChar(255)
  base_url             String              @unique
  is_active            Boolean             @default(true)
  last_crawl_status    String?             @db.VarChar(50)
  last_crawl_timestamp DateTime?           @db.Timestamptz(6)
  created_at           DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at           DateTime?           @default(now()) @db.Timestamptz(6)
  crawled_files_log    crawled_files_log[]

  @@schema("controller")
}

model tbl_base_product_reviews {
  id                BigInt    @id @default(autoincrement())
  review_id         String    @unique(map: "uq_base_reviews_review_id") @db.VarChar(50)
  product_id        String?   @db.VarChar(50)
  sku_id            String?   @db.VarChar(50)
  sku_specification String?   @db.VarChar(255)
  rating            Int?
  display_text      String?
  images            Json?
  review_timestamp  DateTime? @db.Timestamptz(6)
  media             Json?
  load_timestamp    DateTime? @default(now()) @db.Timestamptz(6)

  @@index([product_id], map: "idx_base_reviews_product_id")
  @@index([sku_id], map: "idx_base_reviews_sku_id")
  @@schema("staging")
}

model tbl_base_product_skus {
  id             BigInt    @id @default(autoincrement())
  product_id     String?   @db.VarChar(50)
  sku_id         String    @db.VarChar(50)
  sku_sale_props Json?
  stock          Int?
  price_real     Decimal?  @db.Decimal(18, 2)
  price_original Decimal?  @db.Decimal(18, 2)
  valid_to       DateTime? @db.Timestamptz(6)
  load_timestamp DateTime? @default(now()) @db.Timestamptz(6)

  @@index([sku_id], map: "idx_base_skus_sku_id")
  @@schema("staging")
}

model tbl_base_products {
  id             BigInt    @id @default(autoincrement())
  product_id     String    @db.VarChar(50)
  title          String?   @db.VarChar(500)
  description    String?
  specifications Json?
  price_original Decimal?  @db.Decimal(18, 2)
  price_sale     Decimal?  @db.Decimal(18, 2)
  currency       String?   @db.VarChar(10)
  sold_count     Int?
  images         Json?
  avg_rating     Float?
  review_count   Int?
  default_sku_id String?   @db.VarChar(50)
  categories     Json?
  seller_id      String?   @db.VarChar(50)
  valid_to       DateTime? @db.Timestamptz(6)
  load_timestamp DateTime? @default(now()) @db.Timestamptz(6)

  @@index([product_id], map: "idx_base_products_product_id")
  @@schema("staging")
}

model tbl_base_shop_info {
  id                    BigInt    @id @default(autoincrement())
  seller_id             String    @unique(map: "uq_base_shop_seller_id") @db.VarChar(50)
  shop_name             String?   @db.VarChar(255)
  description           String?
  sold_count            BigInt?
  on_sell_product_count Int?
  review_count          BigInt?
  followers_count       BigInt?
  video_count           Int?
  shop_logo             Json?
  shop_rating           Float?
  shop_link             String?   @db.VarChar(1024)
  region                String?   @db.VarChar(50)
  worst_rating          Int?
  best_rating           Int?
  valid_to              DateTime? @db.Timestamptz(6)
  load_timestamp        DateTime? @default(now()) @db.Timestamptz(6)

  @@index([seller_id], map: "idx_base_shop_info_id")
  @@schema("staging")
}

model tbl_products_raw {
  id               BigInt    @id @default(autoincrement())
  product_id       String    @db.VarChar(50)
  raw_data         Json?
  source_file_name String?   @db.VarChar(255)
  load_timestamp   DateTime? @default(now()) @db.Timestamptz(6)

  @@index([product_id], map: "idx_products_raw_product_id")
  @@schema("staging")
}

model agg_product_daily_summary {
  summary_key           Int          @id @default(autoincrement())
  date_key              Int?
  product_key           Int?
  shop_key              Int?
  total_reviews_today   Int?
  avg_rating_today      Decimal?     @db.Decimal(3, 2)
  total_sold_cumulative Int?
  current_stock         Int?
  current_price         Decimal?     @db.Decimal(18, 2)
  dim_date              dim_date?    @relation(fields: [date_key], references: [date_key], onDelete: NoAction, onUpdate: NoAction)
  dim_product           dim_product? @relation(fields: [product_key], references: [product_key], onDelete: NoAction, onUpdate: NoAction)
  dim_shop              dim_shop?    @relation(fields: [shop_key], references: [shop_key], onDelete: NoAction, onUpdate: NoAction)

  @@index([date_key], map: "idx_agg_daily_date")
  @@index([product_key], map: "idx_agg_daily_product")
  @@schema("warehouse")
}

model dim_date {
  date_key                  Int                         @id
  full_date                 DateTime                    @db.Date
  day_of_week               Int                         @db.SmallInt
  day_name                  String                      @db.VarChar(20)
  day_of_month              Int                         @db.SmallInt
  month                     Int                         @db.SmallInt
  month_name                String                      @db.VarChar(20)
  quarter                   Int                         @db.SmallInt
  year                      Int                         @db.SmallInt
  is_weekend                Boolean
  agg_product_daily_summary agg_product_daily_summary[]

  @@schema("warehouse")
}

model dim_product {
  product_key               Int                         @id @default(autoincrement())
  product_id                String                      @db.VarChar(50)
  title                     String?                     @db.VarChar(500)
  description               String?
  default_sku_id            String?                     @db.VarChar(50)
  categories                Json?
  seller_id                 String?                     @db.VarChar(50)
  valid_from                DateTime?                   @default(now()) @db.Timestamp(6)
  valid_to                  DateTime?                   @default(dbgenerated("'9999-12-31 00:00:00'::timestamp without time zone")) @db.Timestamp(6)
  is_current                Boolean?                    @default(true)
  agg_product_daily_summary agg_product_daily_summary[]
  dim_sku                   dim_sku[]
  fact_sales_snapshot       fact_sales_snapshot[]

  @@index([seller_id], map: "idx_dim_product_seller_id")
  @@schema("warehouse")
}

model dim_shop {
  shop_key                  Int                         @id @default(autoincrement())
  seller_id                 String                      @db.VarChar(50)
  shop_name                 String?                     @db.VarChar(255)
  region                    String?                     @db.VarChar(50)
  shop_rating               Float?
  followers_count           BigInt?
  on_sell_product_count     Int?
  valid_from                DateTime?                   @default(now()) @db.Timestamp(6)
  valid_to                  DateTime?                   @default(dbgenerated("'9999-12-31 00:00:00'::timestamp without time zone")) @db.Timestamp(6)
  is_current                Boolean?                    @default(true)
  agg_product_daily_summary agg_product_daily_summary[]
  fact_reviews              fact_reviews[]
  fact_sales_snapshot       fact_sales_snapshot[]

  @@schema("warehouse")
}

model dim_sku {
  sku_key                 Int                       @id @default(autoincrement())
  sku_id                  String                    @db.VarChar(50)
  product_key             Int
  sku_sale_props          Json?
  price_real              Decimal?                  @db.Decimal(18, 2)
  price_original          Decimal?                  @db.Decimal(18, 2)
  sku_specification       String?                   @db.VarChar(255)
  valid_from              DateTime?                 @default(now()) @db.Timestamp(6)
  valid_to                DateTime?                 @default(dbgenerated("'9999-12-31 00:00:00'::timestamp without time zone")) @db.Timestamp(6)
  is_current              Boolean?                  @default(true)
  dim_product             dim_product               @relation(fields: [product_key], references: [product_key], onDelete: NoAction, onUpdate: NoAction)
  fact_inventory_snapshot fact_inventory_snapshot[]
  fact_reviews            fact_reviews[]

  @@index([product_key], map: "idx_dim_sku_product_key")
  @@schema("warehouse")
}

model fact_inventory_snapshot {
  inventory_snapshot_key Int      @id @default(autoincrement())
  sku_key                Int
  date_key               Int
  stock                  Int?
  price_real             Decimal? @db.Decimal(18, 2)
  dim_sku                dim_sku  @relation(fields: [sku_key], references: [sku_key], onDelete: NoAction, onUpdate: NoAction)

  @@index([date_key], map: "idx_fact_inventory_date_key")
  @@index([sku_key], map: "idx_fact_inventory_sku_key")
  @@schema("warehouse")
}

model fact_reviews {
  review_fact_key  Int       @id @default(autoincrement())
  sku_key          Int
  date_key         Int
  shop_key         Int
  review_id        String    @unique(map: "uq_fact_reviews_review_id") @db.VarChar(50)
  rating           Int?
  review_timestamp DateTime? @db.Timestamptz(6)
  dim_shop         dim_shop  @relation(fields: [shop_key], references: [shop_key], onDelete: NoAction, onUpdate: NoAction)
  dim_sku          dim_sku   @relation(fields: [sku_key], references: [sku_key], onDelete: NoAction, onUpdate: NoAction)

  @@index([date_key], map: "idx_fact_reviews_date_key")
  @@index([shop_key], map: "idx_fact_reviews_shop_key")
  @@index([sku_key], map: "idx_fact_reviews_sku_key")
  @@schema("warehouse")
}

model fact_sales_snapshot {
  sales_snapshot_key Int         @id @default(autoincrement())
  product_key        Int
  date_key           Int
  shop_key           Int
  sold_count         Int?
  avg_rating         Float?
  review_count       Int?
  price_sale         Decimal?    @db.Decimal(18, 2)
  dim_product        dim_product @relation(fields: [product_key], references: [product_key], onDelete: NoAction, onUpdate: NoAction)
  dim_shop           dim_shop    @relation(fields: [shop_key], references: [shop_key], onDelete: NoAction, onUpdate: NoAction)

  @@index([date_key], map: "idx_fact_sales_date_key")
  @@index([product_key], map: "idx_fact_sales_product_key")
  @@index([shop_key], map: "idx_fact_sales_shop_key")
  @@schema("warehouse")
}

model data_dictionary_notes {
  id          Int      @id @default(autoincrement())
  schema_name String   @db.VarChar(50)
  table_name  String   @db.VarChar(100)
  column_name String   @db.VarChar(100)
  description String?
  updated_at  DateTime @default(now()) @db.Timestamptz(6)

  @@unique([schema_name, table_name, column_name], map: "uq_dictionary_col")
  @@schema("controller")
}

model system_settings {
  key         String   @id @db.VarChar(100)
  value       String   
  type        String   @default("string") @db.VarChar(20)
  group       String   @db.VarChar(50) // 'DATA_QUALITY', 'CRAWLER', 'GENERAL'
  description String?  
  updated_at  DateTime @default(now()) @db.Timestamptz(6)

  @@schema("controller")
}

================
File: app/sources/page.tsx
================
import { prisma } from "@/lib/prisma";
import { CreateSourceModal } from "@/components/create-source-modal";
import { SourcesTable } from "@/components/sources-table";

const ITEMS_PER_PAGE = 10;

export default async function SourcesPage({
    searchParams,
}: {
    searchParams: Promise<{ [key: string]: string | string[] | undefined }>;
}) {
    const params = await searchParams;
    const page = Number(params?.page) || 1;
    const skip = (page - 1) * ITEMS_PER_PAGE;

    const [sources, totalCount] = await prisma.$transaction([
        prisma.source_config.findMany({
            skip: skip,
            take: ITEMS_PER_PAGE,
            orderBy: { created_at: 'desc' }
        }),
        prisma.source_config.count()
    ]);

    const totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE);

    return (
        <div className="space-y-4">
            <div className="flex justify-between items-center">
                <h1 className="text-2xl font-bold">Cấu Hình Nguồn Dữ Liệu</h1>

                <CreateSourceModal />

            </div>

            <SourcesTable sources={sources} totalPages={totalPages} />
        </div>
    );
}

================
File: package.json
================
{
  "name": "next-app-template",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "dev": "next dev --turbopack",
    "build": "next build",
    "start": "next start",
    "lint": "eslint --fix"
  },
  "dependencies": {
    "@heroui/accordion": "2.2.24",
    "@heroui/alert": "2.2.27",
    "@heroui/autocomplete": "2.3.29",
    "@heroui/avatar": "2.2.22",
    "@heroui/badge": "2.2.17",
    "@heroui/button": "2.2.27",
    "@heroui/card": "2.2.25",
    "@heroui/chip": "2.2.22",
    "@heroui/code": "2.2.21",
    "@heroui/date-picker": "^2.3.28",
    "@heroui/divider": "2.2.20",
    "@heroui/drawer": "2.2.24",
    "@heroui/dropdown": "2.3.27",
    "@heroui/form": "2.1.27",
    "@heroui/framer-utils": "2.1.23",
    "@heroui/image": "2.2.17",
    "@heroui/input": "2.4.28",
    "@heroui/kbd": "2.2.22",
    "@heroui/link": "2.2.23",
    "@heroui/listbox": "2.3.26",
    "@heroui/modal": "2.2.24",
    "@heroui/navbar": "2.2.25",
    "@heroui/pagination": "2.2.24",
    "@heroui/popover": "2.3.27",
    "@heroui/progress": "2.2.22",
    "@heroui/radio": "2.3.27",
    "@heroui/react-utils": "2.1.14",
    "@heroui/scroll-shadow": "2.3.18",
    "@heroui/select": "2.4.28",
    "@heroui/skeleton": "2.2.17",
    "@heroui/snippet": "2.2.28",
    "@heroui/spacer": "2.2.21",
    "@heroui/spinner": "2.2.24",
    "@heroui/switch": "2.2.24",
    "@heroui/system": "2.4.23",
    "@heroui/table": "2.2.27",
    "@heroui/tabs": "2.2.24",
    "@heroui/theme": "2.4.23",
    "@heroui/toast": "2.0.17",
    "@heroui/tooltip": "2.2.24",
    "@heroui/user": "2.2.22",
    "@internationalized/date": "^3.10.0",
    "@monaco-editor/react": "^4.7.0",
    "@prisma/client": "5.14.0",
    "@react-aria/ssr": "3.9.10",
    "@react-aria/visually-hidden": "3.8.28",
    "clsx": "2.1.1",
    "diff": "^8.0.2",
    "framer-motion": "11.18.2",
    "intl-messageformat": "10.7.16",
    "lucide-react": "^0.554.0",
    "next": "15.3.1",
    "next-themes": "0.4.6",
    "react": "18.3.1",
    "react-dom": "18.3.1",
    "react-json-view": "^1.21.3",
    "recharts": "^3.5.0",
    "sonner": "^2.0.7",
    "tailwind-merge": "^3.4.0",
    "use-debounce": "^10.0.6",
    "xlsx": "^0.18.5"
  },
  "devDependencies": {
    "@next/eslint-plugin-next": "15.3.4",
    "@react-types/shared": "3.32.1",
    "@tailwindcss/postcss": "4.1.11",
    "@types/diff": "^8.0.0",
    "@types/node": "20.5.7",
    "@types/react": "18.3.3",
    "@types/react-dom": "18.3.0",
    "@typescript-eslint/eslint-plugin": "8.34.1",
    "@typescript-eslint/parser": "8.34.1",
    "eslint": "9.25.1",
    "eslint-config-next": "15.3.4",
    "eslint-config-prettier": "9.1.0",
    "eslint-plugin-import": "2.31.0",
    "eslint-plugin-jsx-a11y": "6.10.2",
    "eslint-plugin-node": "11.1.0",
    "eslint-plugin-prettier": "5.2.1",
    "eslint-plugin-react": "7.37.5",
    "eslint-plugin-react-hooks": "5.2.0",
    "eslint-plugin-unused-imports": "4.1.4",
    "globals": "16.0.0",
    "postcss": "8.5.6",
    "prettier": "3.5.3",
    "prisma": "5.14.0",
    "tailwind-variants": "3.1.1",
    "tailwindcss": "4.1.11",
    "typescript": "5.6.3"
  }
}

================
File: components/sidebar.tsx
================
"use client";

import { usePathname } from "next/navigation";
import Link from "next/link";
import { Accordion, AccordionItem } from "@heroui/accordion";
import {
  HomeIcon,
  DatabaseIcon,
  FileTextIcon,
  SettingsIcon,
  LayersIcon,
  BarChart3Icon,
  StoreIcon,
  ServerIcon,
  PackageSearchIcon,
  ActivityIcon,
  MessageSquareIcon,
  TerminalIcon,
  ShieldCheckIcon,
  BookOpenIcon,
  PanelLeftClose
} from "lucide-react";
import { ThemeSwitch } from "./theme-switch";
import { CommandPalette } from "./command-palette";
import { useSidebar } from "./sidebar-context";
import clsx from "clsx";
import { Tooltip } from "@heroui/tooltip";
import { Button } from "@heroui/button";

// Định nghĩa cấu trúc Menu
const menuGroups = [
  {
    key: "monitoring",
    title: "Monitoring",
    icon: ActivityIcon,
    items: [
      { name: "Tổng Quan", href: "/", icon: HomeIcon },
      { name: "Lịch Sử Crawl", href: "/logs", icon: FileTextIcon },
    ]
  },
  {
    key: "controller",
    title: "Controller",
    icon: SettingsIcon,
    items: [
      { name: "Cấu Hình Datasource", href: "/sources", icon: ServerIcon },
    ]
  },
  {
    key: "staging",
    title: "Staging",
    icon: DatabaseIcon,
    items: [
      { name: "Dữ Liệu Thô", href: "/raw-data", icon: DatabaseIcon },
      { name: "Dữ Liệu Đã Xử Lý", href: "/products", icon: PackageSearchIcon },
      { name: "Danh Mục Cửa Hàng", href: "/shops", icon: StoreIcon },
    ]
  },
  {
    key: "warehouse",
    title: "Warehouse",
    icon: LayersIcon,
    items: [
      { name: "Phân Tích Bán Hàng", href: "/analytics", icon: BarChart3Icon },
      { name: "Đánh Giá Khách Hàng", href: "/reviews", icon: MessageSquareIcon }
    ]
  }, {
    key: "tools",
    title: "Tools",
    icon: SettingsIcon,
    items: [
      { name: "SQL Sandbox", href: "/playground", icon: TerminalIcon },
      { name: "Chất Lượng Dữ Liệu", href: "/data-quality", icon: ShieldCheckIcon },
      { name: "Sức Khỏe Hệ Thống", href: "/system-health", icon: ActivityIcon },
      { name: "Từ Điển Dữ Liệu", href: "/dictionary", icon: BookOpenIcon },
      { name: "Cấu Hình Hệ Thống", href: "/settings", icon: SettingsIcon }
    ]
  },
];

export const Sidebar = () => {
  const pathname = usePathname();
  const { isOpen, toggleSidebar } = useSidebar();

  // Logic để xác định Group nào đang Active dựa trên URL hiện tại
  // Để tự động mở Dropdown khi reload trang
  const defaultExpandedKeys = menuGroups
    .filter(group => group.items.some(item => item.href === pathname))
    .map(group => group.key);

  // Nếu đang ở trang chủ /, mặc định mở nhóm Monitoring
  if (pathname === "/" && !defaultExpandedKeys.includes("monitoring")) {
    defaultExpandedKeys.push("monitoring");
  }

  return (
    <aside
      className={clsx(
        "h-screen bg-content1 border-r border-divider flex flex-col fixed left-0 top-0 z-50 transition-all duration-300 ease-in-out",
        // Logic ẩn hiện: Nếu đóng thì dịch sang trái (-translate-x-full)
        isOpen ? "w-64 translate-x-0" : "w-64 -translate-x-full"
      )}
    >
      {/* Header */}
      <div className="h-16 flex items-center px-6 border-b border-divider gap-2 justify-between">
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
            <span className="text-white font-bold text-lg">D</span>
          </div>
          <span className="text-xl font-bold text-foreground">DW Admin</span>
        </div>
        <Tooltip content="Thu gọn Menu">
          <Button
            isIconOnly
            variant="light"
            size="sm"
            onPress={toggleSidebar}
            className="text-default-500 hover:text-foreground"
          >
            <PanelLeftClose size={24} />
          </Button>
        </Tooltip>
      </div>
      <div className="px-4 py-4">
        <CommandPalette />
      </div>

      {/* Navigation (Scrollable) */}
      <nav className="flex-1 overflow-y-auto py-4 px-2">
        <Accordion
          selectionMode="multiple"
          defaultExpandedKeys={defaultExpandedKeys}
          itemClasses={{
            base: "px-0",
            title: "font-semibold text-default-600",
            trigger: "px-2 py-0 data-[hover=true]:bg-default-100 rounded-lg h-12 flex items-center",
            indicator: "text-medium",
            content: "text-small px-2",
          }}
          showDivider={false}
        >
          {menuGroups.map((group) => (
            <AccordionItem
              key={group.key}
              aria-label={group.title}
              title={group.title}
              startContent={<group.icon size={20} className="text-default-500" />}
            >
              <ul className="flex flex-col gap-1 pb-2">
                {group.items.map((item) => {
                  const isActive = pathname === item.href;
                  return (
                    <li key={item.href}>
                      <Link
                        href={item.href}
                        className={`flex items-center gap-3 px-3 py-2 rounded-medium transition-colors ${isActive
                          ? "bg-primary/10 text-primary font-medium"
                          : "text-default-500 hover:bg-default-100 hover:text-foreground"
                          }`}
                      >
                        <item.icon size={18} />
                        <span>{item.name}</span>
                      </Link>
                    </li>
                  );
                })}
              </ul>
            </AccordionItem>
          ))}
        </Accordion>
      </nav>

      {/* Footer (Theme Switch) */}
      <div className="p-4 border-t border-divider">
        <div className="flex items-center justify-between bg-default-50 p-3 rounded-xl">
          <div className="flex flex-col">
            <span className="text-xs font-semibold text-foreground">Cty 2 mình</span>
            <span className="text-[10px] text-default-500">v1.1.0</span>
          </div>
          <ThemeSwitch />
        </div>
      </div>
    </aside>
  );
};





================================================================
End of Codebase
================================================================
